<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="edit_on_doubleclick" content="/">
<meta name="robots" content="index,nofollow">

<title>LMG/Kernel/PPP - Linaro Wiki Archive</title>
<script type="text/javascript" src="LMG_Kernel_PPP%20-%20Linaro%20Wiki%20Archive_files/common.js"></script>

<script type="text/javascript">
<!--
var search_hint = "Search";
//-->
</script>

<script type="text/javascript">
<!-- // GUI edit link and i18n
var gui_editor_link_href = "/LMG/Kernel/PPP?action=edit&editor=gui";
var gui_editor_link_text = "Edit (GUI)";
//-->
</script>

<link rel="stylesheet" type="text/css" charset="utf-8" media="all" href="LMG_Kernel_PPP%20-%20Linaro%20Wiki%20Archive_files/common.css">
<link rel="stylesheet" type="text/css" charset="utf-8" media="screen" href="LMG_Kernel_PPP%20-%20Linaro%20Wiki%20Archive_files/screen.css">
<link rel="stylesheet" type="text/css" charset="utf-8" media="print" href="LMG_Kernel_PPP%20-%20Linaro%20Wiki%20Archive_files/print.css">
<link rel="stylesheet" type="text/css" charset="utf-8" media="projection" href="LMG_Kernel_PPP%20-%20Linaro%20Wiki%20Archive_files/projection.css">

<!-- css only for MS IE6/IE7 browsers -->
<!--[if lt IE 8]>
   <link rel="stylesheet" type="text/css" charset="utf-8" media="all" href="/moin_static198/linaro-white/css/msie.css">
<![endif]-->


<link rel="alternate" title="Linaro Wiki Archive: LMG/Kernel/PPP" href="https://wiki-archive.linaro.org/LMG/Kernel/PPP?diffs=1&amp;show_att=1&amp;action=rss_rc&amp;unique=0&amp;page=LMG%2FKernel%2FPPP&amp;ddiffs=1" type="application/rss+xml">
<link rel="alternate" type="application/wiki" title="Edit" href="https://wiki-archive.linaro.org/LMG/Kernel/PPP?action=edit">

<link rel="Start" href="https://wiki-archive.linaro.org/FrontPage">
<link rel="Alternate" title="Wiki Markup" href="https://wiki-archive.linaro.org/LMG/Kernel/PPP?action=raw">
<link rel="Alternate" media="print" title="Print View" href="https://wiki-archive.linaro.org/LMG/Kernel/PPP?action=print">
<link rel="Up" href="https://wiki-archive.linaro.org/LMG/Kernel">
<link rel="Appendix" title="hikey-master-4.14.txt" href="https://wiki-archive.linaro.org/LMG/Kernel/PPP?action=AttachFile&amp;do=view&amp;target=hikey-master-4.14.txt">
<link rel="Appendix" title="l2tp-setup-overview.png" href="https://wiki-archive.linaro.org/LMG/Kernel/PPP?action=AttachFile&amp;do=view&amp;target=l2tp-setup-overview.png">
<link rel="Appendix" title="l2tp-use-case1.png" href="https://wiki-archive.linaro.org/LMG/Kernel/PPP?action=AttachFile&amp;do=view&amp;target=l2tp-use-case1.png">
<link rel="Appendix" title="l2tp-use-case2.png" href="https://wiki-archive.linaro.org/LMG/Kernel/PPP?action=AttachFile&amp;do=view&amp;target=l2tp-use-case2.png">
<link rel="Appendix" title="vpn_settings.png" href="https://wiki-archive.linaro.org/LMG/Kernel/PPP?action=AttachFile&amp;do=view&amp;target=vpn_settings.png">
<link rel="Appendix" title="wireshark-decrypted.png" href="https://wiki-archive.linaro.org/LMG/Kernel/PPP?action=AttachFile&amp;do=view&amp;target=wireshark-decrypted.png">
<link rel="Appendix" title="wireshark-esp.png" href="https://wiki-archive.linaro.org/LMG/Kernel/PPP?action=AttachFile&amp;do=view&amp;target=wireshark-esp.png">
<link rel="Appendix" title="xl2tpd-logs-analysis.png" href="https://wiki-archive.linaro.org/LMG/Kernel/PPP?action=AttachFile&amp;do=view&amp;target=xl2tpd-logs-analysis.png">
<link rel="Search" href="https://wiki-archive.linaro.org/FindPage">
<link rel="Index" href="https://wiki-archive.linaro.org/TitleIndex">
<link rel="Glossary" href="https://wiki-archive.linaro.org/WordIndex">
<link rel="Help" href="https://wiki-archive.linaro.org/HelpOnFormatting">
<object style="display: none; visibility: hidden;" class="eusw@iit.com.ua"></object></head>

<body dir="ltr" lang="en">
<div id="header">
<div id="header_inner">
<div id="logo" class="repeat"><a class="logo_link" href="https://linaro.org/" title="Linaro homepage"></a>
        </div>
<div id="navigation" class="repeat">
<div id="utility_nav">
        <a href="https://www.linaro.org/">Linaro.org</a> |
        <a href="https://connect.linaro.org/">Linaro Connect</a> </div>
<div id="primary_nav">

<ul id="navibar">
<li class="wikilink"><a href="https://wiki-archive.linaro.org/FrontPage">FrontPage</a></li><li class="wikilink"><a href="https://wiki-archive.linaro.org/RecentChanges">RecentChanges</a></li><li class="wikilink"><a href="https://wiki-archive.linaro.org/FindPage">FindPage</a></li><li class="wikilink"><a href="https://wiki-archive.linaro.org/HelpContents">HelpContents</a></li><li class="current"><a href="https://wiki-archive.linaro.org/LMG/Kernel/PPP">LMG/Kernel/PPP</a></li>
</ul>

</div>
</div>
</div>
</div>
<div id="wrapper">
<div id="wrapper_inner">

        <div id="sidebar" class="repeat">
        <h2>Search Wiki</h2>
        
<form id="searchform" method="get" action="/LMG/Kernel/PPP">
<div>
<input type="hidden" name="action" value="fullsearch">
<input type="hidden" name="context" value="180">
<label for="searchinput">Search:</label>
<input id="searchinput" type="text" name="value" size="20" onfocus="searchFocus(this)" onblur="searchBlur(this)" onkeyup="searchChange(this)" onchange="searchChange(this)" alt="Search">
<input id="titlesearch" name="titlesearch" type="submit" value="Titles" alt="Search Titles">
<input id="fullsearch" name="fullsearch" type="submit" value="Text" alt="Search Full Text">
</div>
</form>
<script type="text/javascript">
<!--// Initialize search form
var f = document.getElementById('searchform');
f.getElementsByTagName('label')[0].style.display = 'none';
var e = document.getElementById('searchinput');
searchChange(e);
searchBlur(e);
//-->
</script>

        <br>
        <h2>User Actions</h2>
        <ul id="username"><li><a href="https://wiki-archive.linaro.org/LMG/Kernel/PPP?action=login" id="login" rel="nofollow">Login</a></li></ul>
        <h2>Page Actions</h2>
        <ul class="editbar"><li><a href="https://wiki-archive.linaro.org/LMG/Kernel/PPP?action=edit&amp;editor=text" name="texteditlink" rel="nofollow">Edit (Text)</a></li><li class="toggleCommentsButton" style="display:none;"><a href="#" class="nbcomment" onclick="toggleComments();return false;">Comments</a></li><li><a class="nbinfo" href="https://wiki-archive.linaro.org/LMG/Kernel/PPP?action=info" rel="nofollow">Info</a></li><li><a class="nbattachments" href="https://wiki-archive.linaro.org/LMG/Kernel/PPP?action=AttachFile" rel="nofollow">Attachments</a></li><li>
<form class="actionsmenu" method="GET" action="/LMG/Kernel/PPP">
<div>
    <label>More Actions:</label>
    <select name="action" onchange="if ((this.selectedIndex != 0) &amp;&amp;
                      (this.options[this.selectedIndex].disabled == false)) {
                this.form.submit();
            }
            this.selectedIndex = 0;">
        <option value="raw" selected="selected">Raw Text</option>
<option value="print">Print View</option>
<option value="RenderAsDocbook">Render as Docbook</option>
<option value="refresh">Delete Cache</option>
<option value="show" disabled="disabled" class="disabled">------------------------</option>
<option value="SpellCheck">Check Spelling</option>
<option value="LikePages">Like Pages</option>
<option value="LocalSiteMap">Local Site Map</option>
<option value="show" disabled="disabled" class="disabled">------------------------</option>
<option value="RenamePage" disabled="disabled" class="disabled">Rename Page</option>
<option value="DeletePage" disabled="disabled" class="disabled">Delete Page</option>
<option value="show" disabled="disabled" class="disabled">------------------------</option>
<option value="show" disabled="disabled" class="disabled">Subscribe User</option>
<option value="show" disabled="disabled" class="disabled">------------------------</option>
<option value="show" disabled="disabled" class="disabled">Remove Spam</option>
<option value="show" disabled="disabled" class="disabled">Revert to this revision</option>
<option value="PackagePages">Package Pages</option>
<option value="SyncPages">Sync Pages</option>
<option value="show" disabled="disabled" class="disabled">------------------------</option>
<option value="Load">Load</option>
<option value="Save">Save</option>
<option value="SlideShow">SlideShow</option>
    </select>
    <input type="submit" value="Do">
    
</div>
<script type="text/javascript">
<!--// Init menu
actionsMenuInit('More Actions:');
//-->
</script>
</form>
</li></ul>

        </div>
        
<div id="content">

<div id="breadcrumbs">

</div><div dir="ltr" id="content" lang="en"><span class="anchor" id="top"></span>
<span class="anchor" id="line-1"></span><p class="line862">Author: <strong>Sam Protsenko</strong> &lt;semen.protsenko at linaro dot org&gt; <span class="anchor" id="line-2"></span><span class="anchor" id="line-3"></span></p><p class="line867">
</p><h1 id="Make_Android_use_upstream_PPP_VPN_code">Make Android use upstream PPP VPN code</h1>
<span class="anchor" id="line-4"></span><span class="anchor" id="line-5"></span><p class="line867"></p><div class="table-of-contents"><p class="table-of-contents-heading">Contents</p><ol><li>
<a href="#Make_Android_use_upstream_PPP_VPN_code">Make Android use upstream PPP VPN code</a><ol><li>
<a href="#Synopsis">Synopsis</a><ol><li>
<a href="#What_is_.22Legacy_VPN.22.3F">What is "Legacy VPN"?</a></li><li>
<a href="#VPN_use-cases">VPN use-cases</a></li></ol></li><li>
<a href="#Common_configuration">Common configuration</a><ol><li>
<a href="#Android">Android</a></li><li>
<a href="#Kernel">Kernel</a></li><li>
<a href="#Network_details">Network details</a></li><li>
<a href="#Network_configuration_.28PC.29">Network configuration (PC)</a></li><li>
<a href="#Bring_up_Ethernet">Bring up Ethernet</a></li><li>
<a href="#Test_Ethernet_connection">Test Ethernet connection</a></li><li>
<a href="#Forward_Internet_.28optional.29">Forward Internet (optional)</a></li></ol></li><li>
<a href="#Protocols">Protocols</a><ol><li>
<a href="#PPTP_protocol">PPTP protocol</a><ol><li>
<a href="#Server_setup">Server setup</a></li><li>
<a href="#Bring_up_PPTP">Bring up PPTP</a></li></ol></li><li>
<a href="#L2TP_protocol">L2TP protocol</a><ol><li>
<a href="#racoon_configuration">racoon configuration</a></li><li>
<a href="#xl2tpd_configuration">xl2tpd configuration</a></li><li>
<a href="#Bring_up_L2TP">Bring up L2TP</a></li><li>
<a href="#Check_correct_L2TP_run">Check correct L2TP run</a></li></ol></li></ol></li><li>
<a href="#Test_PPP">Test PPP</a></li><li>
<a href="#Testing_VPN_over_WiFi">Testing VPN over WiFi</a><ol><li>
<a href="#Configuring_WiFi_Access_Point">Configuring WiFi Access Point</a></li><li>
<a href="#Enabling_VPN_on_device">Enabling VPN on device</a></li></ol></li><li>
<a href="#Development_status">Development status</a></li><li>
<a href="#Debugging_and_development_hints">Debugging and development hints</a><ol><li>
<a href="#Wireshark">Wireshark</a><ol><li>
<a href="#Change_racoon_encoding_algorithm">Change racoon encoding algorithm</a></li><li>
<a href="#Run_sniffing">Run sniffing</a></li><li>
<a href="#Figure_out_IPSec_keys">Figure out IPSec keys</a></li><li>
<a href="#Decrypt_ESP_packets">Decrypt ESP packets</a></li></ol></li><li>
<a href="#Debugging_x2ltpd">Debugging x2ltpd</a><ol><li>
<a href="#Enable_verbose_logs">Enable verbose logs</a></li><li>
<a href="#Add_debug_code_to_xl2tpd">Add debug code to xl2tpd</a></li></ol></li><li>
<a href="#mtpd">mtpd</a><ol><li>
<a href="#Debugging_mtpd">Debugging mtpd</a></li></ol></li><li>
<a href="#Kernel_.28on_Android_side.29">Kernel (on Android side)</a><ol><li>
<a href="#l2tp_debugging">l2tp debugging</a></li><li>
<a href="#Kernel_log_size">Kernel log size</a></li></ol></li></ol></li><li>
<a href="#Development_issues">Development issues</a><ol><li>
<a href="#A.22Can_not_find_tunnel.22_issue:_investigation">"Can not find tunnel" issue: investigation</a></li><li>
<a href="#Byte_order_issues">Byte order issues</a></li><li>
<a href="#pppol2tp.so_is_32-bit_instead_of_64-bit">pppol2tp.so is 32-bit instead of 64-bit</a></li><li>
<a href="#pppol2tp.so_is_not_building_on_fresh_Android_build">pppol2tp.so is not building on fresh Android build</a></li><li>
<a href="#pppol2tp.so_can.27t_be_loaded_by_Bionic_loader">pppol2tp.so can't be loaded by Bionic loader</a></li></ol></li><li>
<a href="#Issues_running_L2TP.2B-IPSec_on_Android-N">Issues running L2TP+IPSec on Android-N</a><ol><li>
<a href="#A.22Network_is_unreachable.22_issue">"Network is unreachable" issue</a></li><li>
<a href="#PSK_permissions_issue">PSK permissions issue</a></li><li>
<a href="#A.22authtype_mismatched.22_issue">"authtype mismatched" issue</a></li><li>
<a href="#A.22pfkey_failed.22_racoon_issue">"pfkey failed" racoon issue</a></li><li>
<a href="#A.22Received_signal_15.22_mtpd_issue">"Received signal 15" mtpd issue</a></li><li>
<a href="#A.22Received_signal_15.22_mtpd_issue_.28.232.29">"Received signal 15" mtpd issue (#2)</a><ol><li>
<a href="#Debugging_the_truncation">Debugging the truncation</a></li></ol></li><li>
<a href="#A.22avp_is_incorrect_size.__8_.3C_10.22_issue">"avp is incorrect size.  8 &lt; 10" issue</a></li><li>
<a href="#udp_xmit_failed_with_err.3D-1:No_such_device">udp_xmit failed with err=-1:No such device</a></li></ol></li><li>
<a href="#References">References</a></li></ol></li></ol></div> <span class="anchor" id="line-6"></span><span class="anchor" id="line-7"></span><p class="line867">
</p><h2 id="Synopsis">Synopsis</h2>
<span class="anchor" id="line-8"></span><span class="anchor" id="line-9"></span><p class="line874">This wiki page is intended to document next things: <span class="anchor" id="line-10"></span></p><ul><li><p class="line862">Setup configuration for <a class="https" href="https://projects.linaro.org/browse/LCG-882">LCG-882</a> ticket ("Upstream android PPP related drivers") <span class="anchor" id="line-11"></span></p></li><li>Development status <span class="anchor" id="line-12"></span></li><li>Debugging notes <span class="anchor" id="line-13"></span><span class="anchor" id="line-14"></span></li></ul><p class="line862">Hereafter is described how to create "Android &lt;-&gt; PC" setup: <span class="anchor" id="line-15"></span></p><ul><li><p class="line891">BeagleBoard X15 will be acting as PPP client. It may be any other ARM board with Android and Ethernet on it. <span class="anchor" id="line-16"></span></p></li><li>PC will be acting as PPP server <span class="anchor" id="line-17"></span><span class="anchor" id="line-18"></span></li></ul><p class="line874">Software: <span class="anchor" id="line-19"></span></p><ul><li>The OS used for PC is Debian "stretch" (testing). But it should work flawlessly for Ubuntu as well. <span class="anchor" id="line-20"></span></li><li>On BBB X15 I used Android "Nougat" <span class="anchor" id="line-21"></span><span class="anchor" id="line-22"></span></li></ul><p class="line874">PC and X15 should be connected via Ethernet patch cord. <span class="anchor" id="line-23"></span><span class="anchor" id="line-24"></span></p><p class="line862">This article describes setup of <strong>Legacy VPN</strong> (which is needed for <a class="https" href="https://projects.linaro.org/browse/LCG-882">LCG-882</a> task), for both client (Android board) and server (PC) side. <span class="anchor" id="line-25"></span><span class="anchor" id="line-26"></span></p><p class="line867">
</p><h3 id="What_is_.22Legacy_VPN.22.3F">What is "Legacy VPN"?</h3>
<span class="anchor" id="line-27"></span><span class="anchor" id="line-28"></span><p class="line862">Prior
 to Android 4.0, VPN support was entirely built into the platform and 
wasn’t extensible. Support for new VPN types could only be added as part
 of platform updates. To distinguish it from <strong>application-based</strong> implementations, built-in VPN support is referred to as <strong>legacy VPN</strong>. <span class="anchor" id="line-29"></span><span class="anchor" id="line-30"></span></p><p class="line862">Early
 Android versions supported different VPN configurations based on PPTP 
and L2TP/IPsec, with support for “pure-IPSec” VPNs using IPSec Xauth 
added in version 4.0. In addition to new built-in VPN configurations, 
Android 4.0 also introduced <strong>application-based VPNs</strong> by supplying the base platform class <tt class="backtick">VpnService</tt>, which applications could extend in order to implement a new VPN solution. <span class="anchor" id="line-31"></span><span class="anchor" id="line-32"></span></p><p class="line867">
</p><h3 id="VPN_use-cases">VPN use-cases</h3>
<span class="anchor" id="line-33"></span><span class="anchor" id="line-34"></span><p class="line862">General
 VPN use-case for Android devices is next: Android device connected to 
Internet (via WiFi), and we are creating tunnel over Internet to some 
corporate network. This use-case is shown on picture below. <span class="anchor" id="line-35"></span><span class="anchor" id="line-36"></span></p><p class="line867"><img alt="l2tp-use-case1.png" class="attachment" src="LMG_Kernel_PPP%20-%20Linaro%20Wiki%20Archive_files/PPP_003.png" title="l2tp-use-case1.png" align="middle">  <span class="anchor" id="line-37"></span><span class="anchor" id="line-38"></span></p><p class="line874">But
 in this article we are gonna use another setup (it's more convenient 
for development): Android device connected to developer's PC via 
Ethernet. This use-case is shown on picture below. <span class="anchor" id="line-39"></span><span class="anchor" id="line-40"></span></p><p class="line867"><img alt="l2tp-use-case2.png" class="attachment" src="LMG_Kernel_PPP%20-%20Linaro%20Wiki%20Archive_files/PPP.png" title="l2tp-use-case2.png" align="middle">  <span class="anchor" id="line-41"></span><span class="anchor" id="line-42"></span></p><p class="line867">
</p><h2 id="Common_configuration">Common configuration</h2>
<span class="anchor" id="line-43"></span><span class="anchor" id="line-44"></span><p class="line874">Things described in this section are common for both PPTP and L2TP protocols. <span class="anchor" id="line-45"></span><span class="anchor" id="line-46"></span></p><p class="line867">
</p><h3 id="Android">Android</h3>
<span class="anchor" id="line-47"></span><span class="anchor" id="line-48"></span><div><table><tbody><tr>  <td style="background-color: #FFFF00"><p class="line891"><strong>Android</strong> version I'm using: 7.0 ("Nougat")</p></td>
</tr>
</tbody></table></div><span class="anchor" id="line-49"></span><span class="anchor" id="line-50"></span><p class="line862">See <a class="https" href="https://wiki.linaro.org/Boards/BeagleBoard-X15">these instructions</a> for AOSP build instructions (for X15 board). <span class="anchor" id="line-51"></span><span class="anchor" id="line-52"></span></p><p class="line867">
</p><h3 id="Kernel">Kernel</h3>
<span class="anchor" id="line-53"></span><span class="anchor" id="line-54"></span><div><table><tbody><tr>  <td style="background-color: #FFFF00"><p class="line891"><strong>kernel</strong> version I'm using: 4.4</p></td>
</tr>
</tbody></table></div><span class="anchor" id="line-55"></span><span class="anchor" id="line-56"></span><p class="line874">Kernel for Android should be built with next options enabled: <span class="anchor" id="line-57"></span><span class="anchor" id="line-58"></span><span class="anchor" id="line-59"></span><span class="anchor" id="line-60"></span><span class="anchor" id="line-61"></span><span class="anchor" id="line-62"></span><span class="anchor" id="line-63"></span><span class="anchor" id="line-64"></span><span class="anchor" id="line-65"></span><span class="anchor" id="line-66"></span><span class="anchor" id="line-67"></span><span class="anchor" id="line-68"></span><span class="anchor" id="line-69"></span><span class="anchor" id="line-70"></span><span class="anchor" id="line-71"></span><span class="anchor" id="line-72"></span><span class="anchor" id="line-73"></span><span class="anchor" id="line-74"></span><span class="anchor" id="line-75"></span><span class="anchor" id="line-76"></span><span class="anchor" id="line-77"></span><span class="anchor" id="line-78"></span><span class="anchor" id="line-79"></span><span class="anchor" id="line-80"></span><span class="anchor" id="line-81"></span><span class="anchor" id="line-82"></span><span class="anchor" id="line-83"></span><span class="anchor" id="line-84"></span><span class="anchor" id="line-85"></span><span class="anchor" id="line-86"></span><span class="anchor" id="line-87"></span><span class="anchor" id="line-88"></span><span class="anchor" id="line-89"></span><span class="anchor" id="line-90"></span><span class="anchor" id="line-91"></span><span class="anchor" id="line-92"></span><span class="anchor" id="line-93"></span><span class="anchor" id="line-94"></span><span class="anchor" id="line-95"></span><span class="anchor" id="line-96"></span><span class="anchor" id="line-97"></span><span class="anchor" id="line-98"></span><span class="anchor" id="line-99"></span><span class="anchor" id="line-100"></span><span class="anchor" id="line-101"></span><span class="anchor" id="line-102"></span><span class="anchor" id="line-103"></span><span class="anchor" id="line-104"></span><span class="anchor" id="line-105"></span><span class="anchor" id="line-106"></span><span class="anchor" id="line-107"></span><span class="anchor" id="line-108"></span><span class="anchor" id="line-109"></span><span class="anchor" id="line-110"></span><span class="anchor" id="line-111"></span><span class="anchor" id="line-112"></span><span class="anchor" id="line-113"></span><span class="anchor" id="line-114"></span><span class="anchor" id="line-115"></span><span class="anchor" id="line-116"></span><span class="anchor" id="line-117"></span><span class="anchor" id="line-118"></span><span class="anchor" id="line-119"></span><span class="anchor" id="line-120"></span><span class="anchor" id="line-121"></span><span class="anchor" id="line-122"></span><span class="anchor" id="line-123"></span><span class="anchor" id="line-124"></span><span class="anchor" id="line-125"></span><span class="anchor" id="line-126"></span><span class="anchor" id="line-127"></span><span class="anchor" id="line-128"></span><span class="anchor" id="line-129"></span><span class="anchor" id="line-130"></span><span class="anchor" id="line-131"></span><span class="anchor" id="line-132"></span><span class="anchor" id="line-133"></span><span class="anchor" id="line-134"></span><span class="anchor" id="line-135"></span><span class="anchor" id="line-136"></span><span class="anchor" id="line-137"></span><span class="anchor" id="line-138"></span></p><pre><span class="anchor" id="line-1"></span># Android kernel PPP implementation
<span class="anchor" id="line-2"></span>CONFIG_PPPOPNS=y
<span class="anchor" id="line-3"></span>CONFIG_PPPOLAC=y
<span class="anchor" id="line-4"></span>
<span class="anchor" id="line-5"></span># Upstream kernel PPP implementation
<span class="anchor" id="line-6"></span>CONFIG_NET_IPGRE_DEMUX=y
<span class="anchor" id="line-7"></span>CONFIG_PPP=y
<span class="anchor" id="line-8"></span>CONFIG_PPP_MPPE=y
<span class="anchor" id="line-9"></span>CONFIG_PPPOE=y
<span class="anchor" id="line-10"></span>CONFIG_PPTP=y
<span class="anchor" id="line-11"></span>CONFIG_L2TP=y
<span class="anchor" id="line-12"></span>CONFIG_L2TP_DEBUGFS=y
<span class="anchor" id="line-13"></span>CONFIG_L2TP_V3=y
<span class="anchor" id="line-14"></span>CONFIG_L2TP_IP=y
<span class="anchor" id="line-15"></span>CONFIG_L2TP_ETH=y
<span class="anchor" id="line-16"></span>CONFIG_PPPOL2TP=y
<span class="anchor" id="line-17"></span>
<span class="anchor" id="line-18"></span># Crypto
<span class="anchor" id="line-19"></span>CONFIG_CRYPTO=y
<span class="anchor" id="line-20"></span>CONFIG_CRYPTO_AUTHENC=y
<span class="anchor" id="line-21"></span>CONFIG_CRYPTO_MD5=y
<span class="anchor" id="line-22"></span>CONFIG_CRYPTO_CBC=y
<span class="anchor" id="line-23"></span>CONFIG_CRYPTO_SHA1=y
<span class="anchor" id="line-24"></span>CONFIG_CRYPTO_SHA512=y
<span class="anchor" id="line-25"></span>CONFIG_CRYPTO_RMD160=y
<span class="anchor" id="line-26"></span>CONFIG_CRYPTO_ECHAINIV=y
<span class="anchor" id="line-27"></span>CONFIG_CRYPTO_AES=y
<span class="anchor" id="line-28"></span>CONFIG_CRYPTO_ANUBIS=y
<span class="anchor" id="line-29"></span>CONFIG_CRYPTO_ARC4=y
<span class="anchor" id="line-30"></span>CONFIG_CRYPTO_BLOWFISH=y
<span class="anchor" id="line-31"></span>CONFIG_CRYPTO_BLOWFISH_COMMON=y
<span class="anchor" id="line-32"></span>CONFIG_CRYPTO_CAMELLIA=y
<span class="anchor" id="line-33"></span>CONFIG_CRYPTO_CAST_COMMON=y
<span class="anchor" id="line-34"></span>CONFIG_CRYPTO_CAST5=y
<span class="anchor" id="line-35"></span>CONFIG_CRYPTO_CAST6=y
<span class="anchor" id="line-36"></span>CONFIG_CRYPTO_DES=y
<span class="anchor" id="line-37"></span>CONFIG_CRYPTO_FCRYPT=y
<span class="anchor" id="line-38"></span>CONFIG_CRYPTO_KHAZAD=y
<span class="anchor" id="line-39"></span>CONFIG_CRYPTO_SALSA20=y
<span class="anchor" id="line-40"></span>CONFIG_CRYPTO_CHACHA20=y
<span class="anchor" id="line-41"></span>CONFIG_CRYPTO_SEED=y
<span class="anchor" id="line-42"></span>CONFIG_CRYPTO_SERPENT=y
<span class="anchor" id="line-43"></span>CONFIG_CRYPTO_TEA=y
<span class="anchor" id="line-44"></span>CONFIG_CRYPTO_TWOFISH=y
<span class="anchor" id="line-45"></span>CONFIG_CRYPTO_CMAC=y
<span class="anchor" id="line-46"></span>CONFIG_CRYPTO_HMAC=y
<span class="anchor" id="line-47"></span>CONFIG_CRYPTO_XCBC=y
<span class="anchor" id="line-48"></span>CONFIG_CRYPTO_VMAC=y
<span class="anchor" id="line-49"></span>
<span class="anchor" id="line-50"></span># IPsec support
<span class="anchor" id="line-51"></span>CONFIG_XFRM=y
<span class="anchor" id="line-52"></span>CONFIG_XFRM_USER=y
<span class="anchor" id="line-53"></span>CONFIG_NET_KEY=y
<span class="anchor" id="line-54"></span>
<span class="anchor" id="line-55"></span># Data compression (AH, ESP and IPComp)
<span class="anchor" id="line-56"></span>CONFIG_INET_AH=y
<span class="anchor" id="line-57"></span>CONFIG_INET_ESP=y
<span class="anchor" id="line-58"></span>CONFIG_XFRM_IPCOMP=y
<span class="anchor" id="line-59"></span>CONFIG_INET_IPCOMP=y
<span class="anchor" id="line-60"></span>
<span class="anchor" id="line-61"></span># Support IPsec in NetFilter
<span class="anchor" id="line-62"></span>CONFIG_IP_NF_MATCH_AH=y
<span class="anchor" id="line-63"></span>CONFIG_NETFILTER_XT_MATCH_ESP=y
<span class="anchor" id="line-64"></span>CONFIG_NETFILTER_XT_MATCH_POLICY=y
<span class="anchor" id="line-65"></span>
<span class="anchor" id="line-66"></span># Transport, tunnel and BEET mode support
<span class="anchor" id="line-67"></span>CONFIG_INET_XFRM_TUNNEL=y
<span class="anchor" id="line-68"></span>CONFIG_INET_XFRM_MODE_TRANSPORT=y
<span class="anchor" id="line-69"></span>CONFIG_INET_XFRM_MODE_TUNNEL=y
<span class="anchor" id="line-70"></span>CONFIG_INET_XFRM_MODE_BEET=y
<span class="anchor" id="line-71"></span>
<span class="anchor" id="line-72"></span># IPv6 support
<span class="anchor" id="line-73"></span>CONFIG_INET6_AH=y
<span class="anchor" id="line-74"></span>CONFIG_INET6_ESP=y
<span class="anchor" id="line-75"></span>CONFIG_INET6_IPCOMP=y
<span class="anchor" id="line-76"></span>CONFIG_INET6_XFRM_TUNNEL=y
<span class="anchor" id="line-77"></span>CONFIG_INET6_XFRM_MODE_TRANSPORT=y
<span class="anchor" id="line-78"></span>CONFIG_INET6_XFRM_MODE_TUNNEL=y
<span class="anchor" id="line-79"></span>CONFIG_INET6_XFRM_MODE_BEET=y
<span class="anchor" id="line-80"></span>CONFIG_IP6_NF_MATCH_AH=y</pre><span class="anchor" id="line-139"></span><span class="anchor" id="line-140"></span><p class="line874">These
 options enable Android implementation of PPP. Without these there will 
be some error (on attempt to start mtpd), related to missing PPPoX 
implementation in kernel. <span class="anchor" id="line-141"></span><span class="anchor" id="line-142"></span></p><p class="line874">Particularly we are interested in next two options (added in Android kernel): <span class="anchor" id="line-143"></span><span class="anchor" id="line-144"></span></p><div><table><tbody><tr>  <td><p class="line862"> <strong>Option</strong> </p></td>
  <td><p class="line862"> <strong>Meaning</strong> </p></td>
  <td><p class="line862"> <strong>Details</strong> </p></td>
</tr>
<tr>  <td><span class="anchor" id="line-145"></span><p class="line862"> CONFIG_PPPOPNS </p></td>
  <td><p class="line862"> PNS (PPTP Network Server) </p></td>
  <td><p class="line862"> <a class="https" href="https://tools.ietf.org/html/rfc2637">RFC2637</a> </p></td>
</tr>
<tr>  <td><span class="anchor" id="line-146"></span><p class="line862"> CONFIG_PPPOLAC </p></td>
  <td><p class="line862"> LAC (L2TP Access Concentrator) </p></td>
  <td><p class="line862"> <a class="https" href="https://tools.ietf.org/html/rfc2661">RFC2661</a> </p></td>
</tr>
</tbody></table></div><span class="anchor" id="line-147"></span><span class="anchor" id="line-148"></span><p class="line874">In order to use mainline implementation of L2TP next options should be enabled in kernel: <span class="anchor" id="line-149"></span></p><ul><li><p class="line891"><tt class="backtick">CONFIG_L2TP</tt> <span class="anchor" id="line-150"></span></p></li><li><p class="line891"><tt class="backtick">CONFIG_L2TP_DEBUGFS</tt> <span class="anchor" id="line-151"></span></p></li><li><p class="line891"><tt class="backtick">CONFIG_L2TP_V3</tt> <span class="anchor" id="line-152"></span></p></li><li><p class="line891"><tt class="backtick">CONFIG_L2TP_IP</tt> <span class="anchor" id="line-153"></span></p></li><li><p class="line891"><tt class="backtick">CONFIG_L2TP_ETH</tt> <span class="anchor" id="line-154"></span></p></li><li><p class="line891"><tt class="backtick">CONFIG_PPPOL2TP</tt> <span class="anchor" id="line-155"></span><span class="anchor" id="line-156"></span></p></li></ul><p class="line867">
</p><h3 id="Network_details">Network details</h3>
<span class="anchor" id="line-157"></span><span class="anchor" id="line-158"></span><p class="line862">BBB
 X15 doesn't have any WiFi chips on it, so I will use Ethernet 
connection for PPP. Because Android GUI doesn't have an option to use 
Ethernet, all configuration will be done from console exclusively. <span class="anchor" id="line-159"></span><span class="anchor" id="line-160"></span></p><p class="line874">Next networks and addresses will be used in this setup: <span class="anchor" id="line-161"></span><span class="anchor" id="line-162"></span><span class="anchor" id="line-163"></span><span class="anchor" id="line-164"></span><span class="anchor" id="line-165"></span><span class="anchor" id="line-166"></span><span class="anchor" id="line-167"></span><span class="anchor" id="line-168"></span><span class="anchor" id="line-169"></span></p><pre><span class="anchor" id="line-1-1"></span>Ethernet:
<span class="anchor" id="line-2-1"></span>    192.168.0.1   - server
<span class="anchor" id="line-3-1"></span>    192.168.0.100 - client
<span class="anchor" id="line-4-1"></span>
<span class="anchor" id="line-5-1"></span>PPP:
<span class="anchor" id="line-6-1"></span>    192.168.2.1   - VPN server (PC)
<span class="anchor" id="line-7-1"></span>    192.168.2.100 - Android (BB X15)</pre><span class="anchor" id="line-170"></span><span class="anchor" id="line-171"></span><p class="line867">
</p><h3 id="Network_configuration_.28PC.29">Network configuration (PC)</h3>
<span class="anchor" id="line-172"></span><span class="anchor" id="line-173"></span><p class="line862">Enable IP forwarding. Edit <tt class="backtick">/etc/sysctl.conf</tt> and add/change next line: <span class="anchor" id="line-174"></span><span class="anchor" id="line-175"></span><span class="anchor" id="line-176"></span></p><pre><span class="anchor" id="line-1-2"></span>net.ipv4.ip_forward=1</pre><span class="anchor" id="line-177"></span><span class="anchor" id="line-178"></span><p class="line874">and do next to enable this setting for current session: <span class="anchor" id="line-179"></span><span class="anchor" id="line-180"></span><span class="anchor" id="line-181"></span></p><pre><span class="anchor" id="line-1-3"></span>$ sudo service procps start</pre><span class="anchor" id="line-182"></span><span class="anchor" id="line-183"></span><p class="line862">Ethernet configuration for server (in <tt class="backtick">/etc/network/interfaces</tt>): <span class="anchor" id="line-184"></span><span class="anchor" id="line-185"></span><span class="anchor" id="line-186"></span><span class="anchor" id="line-187"></span><span class="anchor" id="line-188"></span><span class="anchor" id="line-189"></span><span class="anchor" id="line-190"></span></p><pre><span class="anchor" id="line-1-4"></span>auto eth0
<span class="anchor" id="line-2-2"></span>allow-hotplug eth0
<span class="anchor" id="line-3-2"></span>iface eth0 inet static
<span class="anchor" id="line-4-2"></span>    address 192.168.0.1
<span class="anchor" id="line-5-2"></span>    netmask 255.255.255.0</pre><span class="anchor" id="line-191"></span><span class="anchor" id="line-192"></span><p class="line867"><strong>NOTE</strong>: if you are using NetworkManager, you also may be needed to enable "managed" mode in NetworkManager config file. <span class="anchor" id="line-193"></span><span class="anchor" id="line-194"></span></p><p class="line874">Install PPP daemon: <span class="anchor" id="line-195"></span><span class="anchor" id="line-196"></span><span class="anchor" id="line-197"></span></p><pre><span class="anchor" id="line-1-5"></span>$ sudo aptitude install ppp</pre><span class="anchor" id="line-198"></span><span class="anchor" id="line-199"></span><p class="line862">Next CHAP authentication parameters will be used (corresponding lines will be added to <tt class="backtick">/etc/ppp/chap-secrets</tt> later): <span class="anchor" id="line-200"></span><span class="anchor" id="line-201"></span></p><div><table><tbody><tr>  <td><p class="line862"> user </p></td>
  <td><p class="line862"> joe </p></td>
</tr>
<tr>  <td><span class="anchor" id="line-202"></span><p class="line862"> password </p></td>
  <td><p class="line862"> test1234 </p></td>
</tr>
</tbody></table></div><span class="anchor" id="line-203"></span><span class="anchor" id="line-204"></span><p class="line867">
</p><h3 id="Bring_up_Ethernet">Bring up Ethernet</h3>
<span class="anchor" id="line-205"></span><span class="anchor" id="line-206"></span><p class="line867"><em>On Android</em>: bring up Ethernet <span class="anchor" id="line-207"></span><span class="anchor" id="line-208"></span><span class="anchor" id="line-209"></span><span class="anchor" id="line-210"></span><span class="anchor" id="line-211"></span><span class="anchor" id="line-212"></span><span class="anchor" id="line-213"></span><span class="anchor" id="line-214"></span></p><pre><span class="anchor" id="line-1-6"></span>$ su
<span class="anchor" id="line-2-3"></span># ip addr add 192.168.0.100 dev eth0
<span class="anchor" id="line-3-3"></span># ip link set eth0 up
<span class="anchor" id="line-4-3"></span># ip route add 192.168.0.0/24 dev eth0
<span class="anchor" id="line-5-3"></span># ip route add default via 192.168.0.1 dev eth0
<span class="anchor" id="line-6-2"></span># ip rule add from all lookup main pref 99</pre><span class="anchor" id="line-215"></span><span class="anchor" id="line-216"></span><p class="line867"><em>On PC</em>: if you don't see <tt class="backtick">eth0</tt> in <tt class="backtick">ifconfig</tt> output, bring up the Ethernet like this: <span class="anchor" id="line-217"></span><span class="anchor" id="line-218"></span><span class="anchor" id="line-219"></span><span class="anchor" id="line-220"></span></p><pre><span class="anchor" id="line-1-7"></span>$ sudo service networking stop
<span class="anchor" id="line-2-4"></span>$ sudo service networking start</pre><span class="anchor" id="line-221"></span><span class="anchor" id="line-222"></span><p class="line867">
</p><h3 id="Test_Ethernet_connection">Test Ethernet connection</h3>
<span class="anchor" id="line-223"></span><span class="anchor" id="line-224"></span><p class="line867"><em>On Android</em>: <span class="anchor" id="line-225"></span><span class="anchor" id="line-226"></span><span class="anchor" id="line-227"></span><span class="anchor" id="line-228"></span><span class="anchor" id="line-229"></span><span class="anchor" id="line-230"></span><span class="anchor" id="line-231"></span><span class="anchor" id="line-232"></span><span class="anchor" id="line-233"></span><span class="anchor" id="line-234"></span><span class="anchor" id="line-235"></span><span class="anchor" id="line-236"></span><span class="anchor" id="line-237"></span><span class="anchor" id="line-238"></span><span class="anchor" id="line-239"></span><span class="anchor" id="line-240"></span><span class="anchor" id="line-241"></span></p><pre><span class="anchor" id="line-1-8"></span># ip addr show dev eth0 scope global
<span class="anchor" id="line-2-5"></span>
<span class="anchor" id="line-3-4"></span>    2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
<span class="anchor" id="line-4-4"></span>        link/ether a0:f6:fd:ad:d9:b8 brd ff:ff:ff:ff:ff:ff
<span class="anchor" id="line-5-4"></span>        inet 192.168.0.100/32 scope global eth0
<span class="anchor" id="line-6-3"></span>           valid_lft forever preferred_lft forever
<span class="anchor" id="line-7-2"></span>
<span class="anchor" id="line-8-1"></span># ip route show
<span class="anchor" id="line-9-1"></span>
<span class="anchor" id="line-10-1"></span>    default via 192.168.0.1 dev eth01
<span class="anchor" id="line-11-1"></span>    192.168.0.0/24 dev eth0  scope link 
<span class="anchor" id="line-12-1"></span>
<span class="anchor" id="line-13-1"></span># ping 192.168.0.1
<span class="anchor" id="line-14-1"></span>
<span class="anchor" id="line-15-1"></span>    // ping should work</pre><span class="anchor" id="line-242"></span><span class="anchor" id="line-243"></span><p class="line867">
</p><h3 id="Forward_Internet_.28optional.29">Forward Internet (optional)</h3>
<span class="anchor" id="line-244"></span><span class="anchor" id="line-245"></span><p class="line874">This section describes how to provide internet connection to Android from PC via Ethernet. <span class="anchor" id="line-246"></span><span class="anchor" id="line-247"></span></p><p class="line867"><em>On PC</em>: Configure IPtables to grant access for your board's subnet to public network (with Internet): <span class="anchor" id="line-248"></span><span class="anchor" id="line-249"></span><span class="anchor" id="line-250"></span></p><pre><span class="anchor" id="line-1-9"></span>$ sudo iptables -A POSTROUTING -t nat -o wlan0 -s 192.168.0.0/24 -j MASQUERADE</pre><span class="anchor" id="line-251"></span><span class="anchor" id="line-252"></span><p class="line862">where public interface is <tt class="backtick">wlan0</tt> and <tt class="backtick">192.168.0.0/24</tt> is Ethernet network. <span class="anchor" id="line-253"></span><span class="anchor" id="line-254"></span></p><p class="line867"><em>On Android</em>: Configure DNS: <span class="anchor" id="line-255"></span><span class="anchor" id="line-256"></span><span class="anchor" id="line-257"></span><span class="anchor" id="line-258"></span><span class="anchor" id="line-259"></span></p><pre><span class="anchor" id="line-1-10"></span># ndc network interface add 100 eth0
<span class="anchor" id="line-2-6"></span># ndc resolver setnetdns 100 localdomain 8.8.8.8 8.8.4.4
<span class="anchor" id="line-3-5"></span># ndc network default set 100</pre><span class="anchor" id="line-260"></span><span class="anchor" id="line-261"></span><p class="line874">Now you can test internet connection in Android browser, or just by pinging some site: <span class="anchor" id="line-262"></span><span class="anchor" id="line-263"></span><span class="anchor" id="line-264"></span></p><pre><span class="anchor" id="line-1-11"></span># ping google.com</pre><span class="anchor" id="line-265"></span><span class="anchor" id="line-266"></span><p class="line867">
</p><h2 id="Protocols">Protocols</h2>
<span class="anchor" id="line-267"></span><span class="anchor" id="line-268"></span><p class="line874">One of these protocols may be used to create VPN connection: <span class="anchor" id="line-269"></span></p><ul><li>PPTP <span class="anchor" id="line-270"></span></li><li>L2TP <span class="anchor" id="line-271"></span><span class="anchor" id="line-272"></span></li></ul><p class="line874">L2TP is more secure, but PPTP is easier to setup. I need both of them for my task. <span class="anchor" id="line-273"></span><span class="anchor" id="line-274"></span></p><p class="line867">
</p><h3 id="PPTP_protocol">PPTP protocol</h3>
<span class="anchor" id="line-275"></span><span class="anchor" id="line-276"></span><p class="line867">
</p><h4 id="Server_setup">Server setup</h4>
<span class="anchor" id="line-277"></span><span class="anchor" id="line-278"></span><p class="line874">In order to test transfer over PPP, install PPTPD on PC (a.k.a server): <span class="anchor" id="line-279"></span><span class="anchor" id="line-280"></span><span class="anchor" id="line-281"></span></p><pre><span class="anchor" id="line-1-12"></span>$ sudo aptitude install pptpd</pre><span class="anchor" id="line-282"></span><span class="anchor" id="line-283"></span><p class="line862">PPTPD configuration (in <tt class="backtick">/etc/pptpd.conf</tt>): <span class="anchor" id="line-284"></span><span class="anchor" id="line-285"></span><span class="anchor" id="line-286"></span><span class="anchor" id="line-287"></span></p><pre><span class="anchor" id="line-1-13"></span>localip 192.168.2.1
<span class="anchor" id="line-2-7"></span>remoteip 192.168.2.100-105</pre><span class="anchor" id="line-288"></span><span class="anchor" id="line-289"></span><p class="line862">Add credentials for authentication using CHAP. In <tt class="backtick">/etc/ppp/chap-secrets</tt> add next line: <span class="anchor" id="line-290"></span><span class="anchor" id="line-291"></span><span class="anchor" id="line-292"></span></p><pre><span class="anchor" id="line-1-14"></span>joe      pptpd   test1234        *</pre><span class="anchor" id="line-293"></span><span class="anchor" id="line-294"></span><p class="line862">Disable MPPE on server. In <tt class="backtick">/etc/ppp/pptpd-options</tt>, remove next line (or comment it out): <span class="anchor" id="line-295"></span><span class="anchor" id="line-296"></span><span class="anchor" id="line-297"></span></p><pre><span class="anchor" id="line-1-15"></span>require-mppe-128</pre><span class="anchor" id="line-298"></span><span class="anchor" id="line-299"></span><p class="line867"></p><hr class="hr3"><p class="line874"> <span class="anchor" id="line-300"></span><span class="anchor" id="line-301"></span></p><p class="line867"><strong>NOTE</strong>: if previous step wasn't done, the connection will be tear down on attempt to start mtpd with next messages: <span class="anchor" id="line-302"></span></p><ul><li><p class="line862">on Android, in output of <tt class="backtick">logcat&nbsp;-s&nbsp;mtpd:*</tt> command: <span class="anchor" id="line-303"></span></p></li></ul><p class="line867"><span class="anchor" id="line-304"></span><span class="anchor" id="line-305"></span></p><pre><span class="anchor" id="line-1-16"></span>I/mtpd    ( 3323): Remote server hung up</pre><span class="anchor" id="line-306"></span><ul><li><p class="line862">on PC, in <tt class="backtick">/var/log/syslog</tt>: <span class="anchor" id="line-307"></span></p></li></ul><p class="line867"><span class="anchor" id="line-308"></span><span class="anchor" id="line-309"></span></p><pre><span class="anchor" id="line-1-17"></span>pppd[9428]: MPPE required but peer refused</pre><p class="line874"> <span class="anchor" id="line-310"></span><span class="anchor" id="line-311"></span></p><p class="line867"></p><hr class="hr4"><p class="line874"> <span class="anchor" id="line-312"></span><span class="anchor" id="line-313"></span></p><p class="line874">Restart networking and pptpd services on server: <span class="anchor" id="line-314"></span><span class="anchor" id="line-315"></span><span class="anchor" id="line-316"></span><span class="anchor" id="line-317"></span><span class="anchor" id="line-318"></span></p><pre><span class="anchor" id="line-1-18"></span>$ sudo service networking stop
<span class="anchor" id="line-2-8"></span>$ sudo service networking start
<span class="anchor" id="line-3-6"></span>$ sudo service pptpd restart</pre><span class="anchor" id="line-319"></span><span class="anchor" id="line-320"></span><p class="line867">
</p><h4 id="Bring_up_PPTP">Bring up PPTP</h4>
<span class="anchor" id="line-321"></span><span class="anchor" id="line-322"></span><p class="line874">Now when server and client are all set to go, let's bring up PPP connection. <span class="anchor" id="line-323"></span><span class="anchor" id="line-324"></span></p><p class="line867"><em>On Android</em>: prepare for running L2TP: <span class="anchor" id="line-325"></span><span class="anchor" id="line-326"></span><span class="anchor" id="line-327"></span></p><pre><span class="anchor" id="line-1-19"></span># rm -f /data/misc/vpn/abort</pre><span class="anchor" id="line-328"></span><span class="anchor" id="line-329"></span><p class="line867"><em>On Android</em>: bring up PPP <span class="anchor" id="line-330"></span><span class="anchor" id="line-331"></span><span class="anchor" id="line-332"></span></p><pre><span class="anchor" id="line-1-20"></span># mtpd eth0 pptp 192.168.0.1 1723 linkname vpn name joe password test1234 refuse-eap nodefaultroute usepeerdns idle 1800 mtu 1400 mru 1400 &amp;</pre><span class="anchor" id="line-333"></span><span class="anchor" id="line-334"></span><p class="line867">
</p><h3 id="L2TP_protocol">L2TP protocol</h3>
<span class="anchor" id="line-335"></span><span class="anchor" id="line-336"></span><p class="line874">Approximate view of the big picture: <span class="anchor" id="line-337"></span><br>
 <span class="anchor" id="line-338"></span><br>
 <span class="anchor" id="line-339"></span><span class="anchor" id="line-340"></span></p><p class="line867"><img alt="l2tp-setup-overview.png" class="attachment" src="LMG_Kernel_PPP%20-%20Linaro%20Wiki%20Archive_files/PPP_005.png" title="l2tp-setup-overview.png" align="middle">  <span class="anchor" id="line-341"></span><span class="anchor" id="line-342"></span></p><p class="line867">
</p><h4 id="racoon_configuration">racoon configuration</h4>
<span class="anchor" id="line-343"></span><span class="anchor" id="line-344"></span><p class="line874">Racoon is IPSec daemon (running on PC). <span class="anchor" id="line-345"></span>There are two options how to use it: <span class="anchor" id="line-346"></span></p><ul><li>PSK (Pre-Shared Key) <span class="anchor" id="line-347"></span></li><li>RSA Certificates <span class="anchor" id="line-348"></span><span class="anchor" id="line-349"></span></li></ul><p class="line874">We will stick to PSK as it's easier to setup and use. <span class="anchor" id="line-350"></span><span class="anchor" id="line-351"></span></p><p class="line874">First install racoon: <span class="anchor" id="line-352"></span><span class="anchor" id="line-353"></span><span class="anchor" id="line-354"></span></p><pre><span class="anchor" id="line-1-21"></span>$ sudo aptitude install racoon</pre><span class="anchor" id="line-355"></span><span class="anchor" id="line-356"></span><p class="line874">(choose "direct" method, if asked by installer). <span class="anchor" id="line-357"></span><span class="anchor" id="line-358"></span></p><div><table><tbody><tr>  <td style="background-color: #FFFF00"><p class="line891"><strong>racoon</strong> version I'm using: 0.8.2</p></td>
</tr>
</tbody></table></div><span class="anchor" id="line-359"></span><span class="anchor" id="line-360"></span><p class="line862">Edit <tt class="backtick">/etc/racoon/psk.txt</tt> so it has only next one line: <span class="anchor" id="line-361"></span><span class="anchor" id="line-362"></span><span class="anchor" id="line-363"></span></p><pre><span class="anchor" id="line-1-22"></span>myhomelan d41d8cd98f00b204e980</pre><span class="anchor" id="line-364"></span><span class="anchor" id="line-365"></span><p class="line867"><strong>NOTE</strong>: be sure that there is no trailing spaces after PSK in racoon config file! <span class="anchor" id="line-366"></span><span class="anchor" id="line-367"></span></p><p class="line874">Restrict permissions to that file, to avoid security errors: <span class="anchor" id="line-368"></span><span class="anchor" id="line-369"></span><span class="anchor" id="line-370"></span></p><pre><span class="anchor" id="line-1-23"></span>$ sudo chmod 0400 /etc/racoon/psk.txt</pre><span class="anchor" id="line-371"></span><span class="anchor" id="line-372"></span><p class="line874">Parameters used are as follows: <span class="anchor" id="line-373"></span></p><div><table><tbody><tr>  <td><p class="line862"> IPSec identifier </p></td>
  <td><p class="line862"> myhomelan </p></td>
</tr>
<tr>  <td><span class="anchor" id="line-374"></span><p class="line862"> IPSec PSK </p></td>
  <td><p class="line862"> d41d8cd98f00b204e980 </p></td>
</tr>
</tbody></table></div><span class="anchor" id="line-375"></span><span class="anchor" id="line-376"></span><p class="line862">Edit <tt class="backtick">/etc/racoon/racoon.conf</tt> so it has next content: <span class="anchor" id="line-377"></span><span class="anchor" id="line-378"></span><span class="anchor" id="line-379"></span><span class="anchor" id="line-380"></span><span class="anchor" id="line-381"></span><span class="anchor" id="line-382"></span><span class="anchor" id="line-383"></span><span class="anchor" id="line-384"></span><span class="anchor" id="line-385"></span><span class="anchor" id="line-386"></span><span class="anchor" id="line-387"></span><span class="anchor" id="line-388"></span><span class="anchor" id="line-389"></span><span class="anchor" id="line-390"></span><span class="anchor" id="line-391"></span><span class="anchor" id="line-392"></span><span class="anchor" id="line-393"></span><span class="anchor" id="line-394"></span><span class="anchor" id="line-395"></span><span class="anchor" id="line-396"></span><span class="anchor" id="line-397"></span><span class="anchor" id="line-398"></span><span class="anchor" id="line-399"></span><span class="anchor" id="line-400"></span><span class="anchor" id="line-401"></span><span class="anchor" id="line-402"></span><span class="anchor" id="line-403"></span></p><pre><span class="anchor" id="line-1-24"></span>log notify;
<span class="anchor" id="line-2-9"></span>path pre_shared_key "/etc/racoon/psk.txt";
<span class="anchor" id="line-3-7"></span>path certificate "/etc/racoon/certs";
<span class="anchor" id="line-4-5"></span>
<span class="anchor" id="line-5-5"></span>remote anonymous {
<span class="anchor" id="line-6-4"></span>        exchange_mode aggressive;
<span class="anchor" id="line-7-3"></span>
<span class="anchor" id="line-8-2"></span>        generate_policy on;
<span class="anchor" id="line-9-2"></span>        nat_traversal on;
<span class="anchor" id="line-10-2"></span>
<span class="anchor" id="line-11-2"></span>        dpd_delay 20;
<span class="anchor" id="line-12-2"></span>
<span class="anchor" id="line-13-2"></span>        proposal {
<span class="anchor" id="line-14-2"></span>                encryption_algorithm aes;
<span class="anchor" id="line-15-2"></span>                hash_algorithm md5;
<span class="anchor" id="line-16-1"></span>                authentication_method pre_shared_key;
<span class="anchor" id="line-17-1"></span>                dh_group modp1024;
<span class="anchor" id="line-18-1"></span>        }
<span class="anchor" id="line-19-1"></span>}
<span class="anchor" id="line-20-1"></span>
<span class="anchor" id="line-21-1"></span>sainfo anonymous {
<span class="anchor" id="line-22-1"></span>        encryption_algorithm aes, 3des;
<span class="anchor" id="line-23-1"></span>        authentication_algorithm hmac_sha256, hmac_md5;
<span class="anchor" id="line-24-1"></span>        compression_algorithm deflate;
<span class="anchor" id="line-25-1"></span>}</pre><span class="anchor" id="line-404"></span><span class="anchor" id="line-405"></span><p class="line867"><strong>NOTE</strong>: pay attention to <tt class="backtick">exchange_mode</tt>: it should be <tt class="backtick">aggressive</tt>, since <tt class="backtick">main</tt> doesn't work with Android for some reasons. <span class="anchor" id="line-406"></span><span class="anchor" id="line-407"></span></p><p class="line867">
</p><h4 id="xl2tpd_configuration">xl2tpd configuration</h4>
<span class="anchor" id="line-408"></span><span class="anchor" id="line-409"></span><p class="line874">xl2tpd is L2TP daemon (running on PC). <span class="anchor" id="line-410"></span><span class="anchor" id="line-411"></span></p><p class="line867"><strong>NOTE</strong>: Look <a class="https" href="https://wiki.linaro.org/LMG/Kernel/PPP#udp_xmit_failed_with_err.3D-1:No_such_device">here</a> first. <span class="anchor" id="line-412"></span><span class="anchor" id="line-413"></span><span class="anchor" id="line-414"></span></p><p class="line874">Install xl2tpd: <span class="anchor" id="line-415"></span><span class="anchor" id="line-416"></span><span class="anchor" id="line-417"></span></p><pre><span class="anchor" id="line-1-25"></span>$ sudo aptitude install xl2tpd</pre><span class="anchor" id="line-418"></span><span class="anchor" id="line-419"></span><div><table><tbody><tr>  <td style="background-color: #FFFF00"><p class="line891"><strong>xl2tpd</strong> version I'm using: 1.3.12</p></td>
</tr>
</tbody></table></div><span class="anchor" id="line-420"></span><span class="anchor" id="line-421"></span><span class="anchor" id="line-422"></span><p class="line862">Edit <tt class="backtick">/etc/xl2tpd/xl2tpd.conf</tt> so it has next content: <span class="anchor" id="line-423"></span><span class="anchor" id="line-424"></span><span class="anchor" id="line-425"></span><span class="anchor" id="line-426"></span><span class="anchor" id="line-427"></span><span class="anchor" id="line-428"></span><span class="anchor" id="line-429"></span><span class="anchor" id="line-430"></span><span class="anchor" id="line-431"></span><span class="anchor" id="line-432"></span><span class="anchor" id="line-433"></span><span class="anchor" id="line-434"></span><span class="anchor" id="line-435"></span><span class="anchor" id="line-436"></span></p><pre><span class="anchor" id="line-1-26"></span>[global]
<span class="anchor" id="line-2-10"></span>access control = no
<span class="anchor" id="line-3-8"></span>
<span class="anchor" id="line-4-6"></span>[lns default]
<span class="anchor" id="line-5-6"></span>ip range = 192.168.2.100-192.168.2.105
<span class="anchor" id="line-6-5"></span>local ip = 192.168.2.1
<span class="anchor" id="line-7-4"></span>require authentication = yes
<span class="anchor" id="line-8-3"></span>require chap = yes
<span class="anchor" id="line-9-3"></span>refuse pap = yes
<span class="anchor" id="line-10-3"></span>length bit = yes
<span class="anchor" id="line-11-3"></span>name = l2tpd
<span class="anchor" id="line-12-3"></span>pppoptfile = /etc/ppp/xl2tpd-options</pre><span class="anchor" id="line-437"></span><span class="anchor" id="line-438"></span><p class="line862">Edit <tt class="backtick">/etc/ppp/xl2tpd-options</tt> so it has next content: <span class="anchor" id="line-439"></span><span class="anchor" id="line-440"></span><span class="anchor" id="line-441"></span><span class="anchor" id="line-442"></span><span class="anchor" id="line-443"></span><span class="anchor" id="line-444"></span><span class="anchor" id="line-445"></span><span class="anchor" id="line-446"></span></p><pre><span class="anchor" id="line-1-27"></span>auth
<span class="anchor" id="line-2-11"></span>nodefaultroute
<span class="anchor" id="line-3-9"></span>proxyarp
<span class="anchor" id="line-4-7"></span>require-chap
<span class="anchor" id="line-5-7"></span>ms-dns 8.8.8.8
<span class="anchor" id="line-6-6"></span>ms-dns 8.8.4.4</pre><span class="anchor" id="line-447"></span><span class="anchor" id="line-448"></span><p class="line862">Add next line to <tt class="backtick">/etc/ppp/chap-secrets</tt>: <span class="anchor" id="line-449"></span><span class="anchor" id="line-450"></span><span class="anchor" id="line-451"></span></p><pre><span class="anchor" id="line-1-28"></span>joe           l2tpd   test1234                *</pre><span class="anchor" id="line-452"></span><span class="anchor" id="line-453"></span><p class="line867">
</p><h4 id="Bring_up_L2TP">Bring up L2TP</h4>
<span class="anchor" id="line-454"></span><span class="anchor" id="line-455"></span><p class="line867"><em>On Android</em>: prepare for running L2TP: <span class="anchor" id="line-456"></span><span class="anchor" id="line-457"></span><span class="anchor" id="line-458"></span></p><pre><span class="anchor" id="line-1-29"></span># rm -f /data/misc/vpn/abort</pre><span class="anchor" id="line-459"></span><span class="anchor" id="line-460"></span><p class="line867"><em>On Android</em>: start IPSec client (in background): <span class="anchor" id="line-461"></span><span class="anchor" id="line-462"></span><span class="anchor" id="line-463"></span></p><pre><span class="anchor" id="line-1-30"></span># racoon eth0 192.168.0.1 udppsk myhomelan d41d8cd98f00b204e980 1701 &amp;</pre><span class="anchor" id="line-464"></span><span class="anchor" id="line-465"></span><p class="line867"><em>On Android</em>: start L2TP client: <span class="anchor" id="line-466"></span><span class="anchor" id="line-467"></span><span class="anchor" id="line-468"></span></p><pre><span class="anchor" id="line-1-31"></span># mtpd eth0 l2tp 192.168.0.1 1701 "" linkname vpn name joe password test1234 refuse-eap nodefaultroute usepeerdns idle 1800 mtu 1400 mru 1400 &amp;</pre><span class="anchor" id="line-469"></span><span class="anchor" id="line-470"></span><p class="line867"><strong>NOTE</strong>: we are passing empty param (<tt class="backtick">""</tt>) instead of secret, because we don't have <tt class="backtick">auth</tt> option enabled in xl2tp config file. <span class="anchor" id="line-471"></span><span class="anchor" id="line-472"></span></p><p class="line867"><strong>NOTE</strong>: If <a class="https" href="https://android-review.googlesource.com/q/topic:%22pppolac%22+(status:open%20OR%20status:merged)">patches for upstream L2TP</a>
 are applied, upstream L2TP will be chosen by default. In case it's not 
enabled in kernel, old Android L2TP implementation will be used as a 
fallback. <span class="anchor" id="line-473"></span><span class="anchor" id="line-474"></span></p><p class="line867">
</p><h4 id="Check_correct_L2TP_run">Check correct L2TP run</h4>
<span class="anchor" id="line-475"></span><span class="anchor" id="line-476"></span><p class="line874">On success, you'll see next lines in terminal: <span class="anchor" id="line-477"></span><span class="anchor" id="line-478"></span><span class="anchor" id="line-479"></span><span class="anchor" id="line-480"></span><span class="anchor" id="line-481"></span><span class="anchor" id="line-482"></span><span class="anchor" id="line-483"></span><span class="anchor" id="line-484"></span><span class="anchor" id="line-485"></span><span class="anchor" id="line-486"></span><span class="anchor" id="line-487"></span><span class="anchor" id="line-488"></span><span class="anchor" id="line-489"></span><span class="anchor" id="line-490"></span><span class="anchor" id="line-491"></span></p><pre><span class="anchor" id="line-1-32"></span>Plugin pppol2tp.so loaded.
<span class="anchor" id="line-2-12"></span>Using interface ppp0
<span class="anchor" id="line-3-10"></span>Connect: ppp0 &lt;--&gt; 
<span class="anchor" id="line-4-8"></span>Overriding mtu 1500 to 1400
<span class="anchor" id="line-5-8"></span>Overriding mru 1500 to mtu value 1400
<span class="anchor" id="line-6-7"></span>
<span class="anchor" id="line-7-5"></span>Overriding mtu 1500 to 1400
<span class="anchor" id="line-8-4"></span>CHAP authentication succeeded: Access granted
<span class="anchor" id="line-9-4"></span>CHAP authentication succeeded
<span class="anchor" id="line-10-4"></span>local  IP address 192.168.2.100
<span class="anchor" id="line-11-4"></span>remote IP address 192.168.2.1
<span class="anchor" id="line-12-4"></span>primary   DNS address 8.8.8.8
<span class="anchor" id="line-13-3"></span>secondary DNS address 8.8.4.4</pre><span class="anchor" id="line-492"></span><span class="anchor" id="line-493"></span><p class="line862">And in <tt class="backtick">logcat</tt> there should be log like this: <span class="anchor" id="line-494"></span><span class="anchor" id="line-495"></span><span class="anchor" id="line-496"></span><span class="anchor" id="line-497"></span><span class="anchor" id="line-498"></span><span class="anchor" id="line-499"></span><span class="anchor" id="line-500"></span><span class="anchor" id="line-501"></span><span class="anchor" id="line-502"></span><span class="anchor" id="line-503"></span><span class="anchor" id="line-504"></span><span class="anchor" id="line-505"></span><span class="anchor" id="line-506"></span><span class="anchor" id="line-507"></span><span class="anchor" id="line-508"></span><span class="anchor" id="line-509"></span><span class="anchor" id="line-510"></span><span class="anchor" id="line-511"></span><span class="anchor" id="line-512"></span><span class="anchor" id="line-513"></span><span class="anchor" id="line-514"></span><span class="anchor" id="line-515"></span><span class="anchor" id="line-516"></span><span class="anchor" id="line-517"></span><span class="anchor" id="line-518"></span><span class="anchor" id="line-519"></span><span class="anchor" id="line-520"></span><span class="anchor" id="line-521"></span><span class="anchor" id="line-522"></span><span class="anchor" id="line-523"></span><span class="anchor" id="line-524"></span><span class="anchor" id="line-525"></span><span class="anchor" id="line-526"></span><span class="anchor" id="line-527"></span><span class="anchor" id="line-528"></span><span class="anchor" id="line-529"></span><span class="anchor" id="line-530"></span><span class="anchor" id="line-531"></span><span class="anchor" id="line-532"></span><span class="anchor" id="line-533"></span><span class="anchor" id="line-534"></span><span class="anchor" id="line-535"></span><span class="anchor" id="line-536"></span><span class="anchor" id="line-537"></span><span class="anchor" id="line-538"></span><span class="anchor" id="line-539"></span><span class="anchor" id="line-540"></span><span class="anchor" id="line-541"></span><span class="anchor" id="line-542"></span><span class="anchor" id="line-543"></span><span class="anchor" id="line-544"></span><span class="anchor" id="line-545"></span><span class="anchor" id="line-546"></span><span class="anchor" id="line-547"></span><span class="anchor" id="line-548"></span><span class="anchor" id="line-549"></span><span class="anchor" id="line-550"></span><span class="anchor" id="line-551"></span><span class="anchor" id="line-552"></span><span class="anchor" id="line-553"></span></p><pre><span class="anchor" id="line-1-33"></span>05-11 01:37:45.851  1743  1743 I racoon  : ipsec-tools 0.7.3 (http://ipsec-tools.sf.net)
<span class="anchor" id="line-2-13"></span>05-11 01:37:45.855  1743  1743 I racoon  : 192.168.0.100[500] used as isakmp port (fd=5)
<span class="anchor" id="line-3-11"></span>05-11 01:37:45.855  1743  1743 I racoon  : 192.168.0.100[500] used for NAT-T
<span class="anchor" id="line-4-9"></span>05-11 01:37:45.855  1743  1743 I racoon  : 192.168.0.100[4500] used as isakmp port (fd=6)
<span class="anchor" id="line-5-9"></span>05-11 01:37:45.855  1743  1743 I racoon  : 192.168.0.100[4500] used for NAT-T
<span class="anchor" id="line-6-8"></span>05-11 01:37:46.448  1768  1768 I mtpd    : Using protocol l2tp
<span class="anchor" id="line-7-6"></span>05-11 01:37:46.448  1768  1768 I mtpd    : Connecting to 192.168.0.1 port 1701 via eth0
<span class="anchor" id="line-8-5"></span>05-11 01:37:46.449  1743  1743 I racoon  : IPsec-SA request for 192.168.0.1 queued due to no phase1 found.
<span class="anchor" id="line-9-5"></span>05-11 01:37:46.449  1743  1743 I racoon  : initiate new phase 1 negotiation: 192.168.0.100[500]&lt;=&gt;192.168.0.1[500]
<span class="anchor" id="line-10-5"></span>05-11 01:37:46.449  1743  1743 I racoon  : begin Aggressive mode.       
<span class="anchor" id="line-11-5"></span>05-11 01:37:46.457  1768  1768 I mtpd    : Connection established (socket = 6)
<span class="anchor" id="line-12-5"></span>05-11 01:37:46.457  1768  1768 D mtpd    : Sending SCCRQ (local_tunnel = 51531)
<span class="anchor" id="line-13-4"></span>05-11 01:37:46.461  1743  1743 I racoon  : received Vendor ID: RFC 3947
<span class="anchor" id="line-14-3"></span>05-11 01:37:46.461  1743  1743 I racoon  : received broken Microsoft ID: FRAGMENTATION
<span class="anchor" id="line-15-3"></span>05-11 01:37:46.461  1743  1743 I racoon  : received Vendor ID: DPD
<span class="anchor" id="line-16-2"></span>05-11 01:37:46.461  1743  1743 I racoon  : Selected NAT-T version: RFC 3947
<span class="anchor" id="line-17-2"></span>05-11 01:37:46.461  1743  1743 I racoon  : Hashing 192.168.0.100[500] with algo #1 
<span class="anchor" id="line-18-2"></span>05-11 01:37:46.461  1743  1743 I racoon  : NAT-D payload #-1 verified
<span class="anchor" id="line-19-2"></span>05-11 01:37:46.461  1743  1743 I racoon  : Hashing 192.168.0.1[500] with algo #1 
<span class="anchor" id="line-20-2"></span>05-11 01:37:46.461  1743  1743 I racoon  : NAT-D payload #0 verified
<span class="anchor" id="line-21-2"></span>05-11 01:37:46.461  1743  1743 I racoon  : NAT not detected 
<span class="anchor" id="line-22-2"></span>05-11 01:37:46.465  1743  1743 I racoon  : couldn't find the proper pskey, try to get one by the peer's address.
<span class="anchor" id="line-23-2"></span>05-11 01:37:46.465  1743  1743 I racoon  : Adding remote and local NAT-D payloads.
<span class="anchor" id="line-24-2"></span>05-11 01:37:46.465  1743  1743 I racoon  : Hashing 192.168.0.1[500] with algo #1 
<span class="anchor" id="line-25-2"></span>05-11 01:37:46.465  1743  1743 I racoon  : Hashing 192.168.0.100[500] with algo #1 
<span class="anchor" id="line-26-1"></span>05-11 01:37:46.466  1743  1743 I racoon  : ISAKMP-SA established 192.168.0.100[500]-192.168.0.1[500] spi:60b055bd50c1e4
<span class="anchor" id="line-27-1"></span>05-11 01:37:47.468  1743  1743 I racoon  : initiate new phase 2 negotiation: 192.168.0.100[500]&lt;=&gt;192.168.0.1[500]
<span class="anchor" id="line-28-1"></span>05-11 01:37:47.470  1743  1743 W racoon  : authtype mismatched: my:hmac-sha512 peer:hmac-sha256
<span class="anchor" id="line-29-1"></span>05-11 01:37:47.470  1743  1743 W racoon  : authtype mismatched: my:hmac-sha384 peer:hmac-sha256
<span class="anchor" id="line-30-1"></span>05-11 01:37:47.470  1743  1743 W racoon  : authtype mismatched: my:hmac-sha peer:hmac-sha256
<span class="anchor" id="line-31-1"></span>05-11 01:37:47.470  1743  1743 I racoon  : IPsec-SA established: ESP/Transport 192.168.0.1[0]-&gt;192.168.0.100[0] spi=88)
<span class="anchor" id="line-32-1"></span>05-11 01:37:47.471  1743  1743 I racoon  : IPsec-SA established: ESP/Transport 192.168.0.100[500]-&gt;192.168.0.1[500] sp)
<span class="anchor" id="line-33-1"></span>
<span class="anchor" id="line-34-1"></span>05-11 01:37:48.459  1768  1768 D mtpd    : Timeout -&gt; Sending SCCRQ
<span class="anchor" id="line-35-1"></span>05-11 01:37:48.460  1768  1768 D mtpd    : Received SCCRP (remote_tunnel = 44607) -&gt; Sending SCCCN
<span class="anchor" id="line-36-1"></span>05-11 01:37:48.461  1768  1768 D mtpd    : Received ACK -&gt; Sending ICRQ (local_session = 2058)
<span class="anchor" id="line-37-1"></span>05-11 01:37:48.461  1768  1768 I mtpd    : Tunnel established
<span class="anchor" id="line-38-1"></span>05-11 01:37:48.462  1768  1768 D mtpd    : Received ICRP (remote_session = 60142) -&gt; Sending ICCN
<span class="anchor" id="line-39-1"></span>05-11 01:37:48.463  1768  1768 D mtpd    : Received ACK
<span class="anchor" id="line-40-1"></span>05-11 01:37:48.463  1768  1768 I mtpd    : Session established
<span class="anchor" id="line-41-1"></span>05-11 01:37:48.463  1768  1768 I mtpd    : Creating PPPoX tunnel socket...
<span class="anchor" id="line-42-1"></span>05-11 01:37:48.463  1768  1768 I mtpd    : Connecting to tunnel socket...
<span class="anchor" id="line-43-1"></span>05-11 01:37:48.463  1768  1768 I mtpd    : Creating PPPoX session socket...
<span class="anchor" id="line-44-1"></span>05-11 01:37:48.463  1768  1768 I mtpd    : Connecting to session socket...
<span class="anchor" id="line-45-1"></span>05-11 01:37:48.463  1768  1768 I mtpd    : Starting pppd (tunnel_fd = 7, session_fd = 8)
<span class="anchor" id="line-46-1"></span>05-11 01:37:48.464  1768  1768 I mtpd    : Pppd started (pid = 1769)
<span class="anchor" id="line-47-1"></span>05-11 01:37:48.480  1769  1769 I pppd    : Plugin pppol2tp.so loaded.
<span class="anchor" id="line-48-1"></span>05-11 01:37:48.483  1769  1769 I pppd    : pppd 2.4.7 started by root, uid 0
<span class="anchor" id="line-49-1"></span>05-11 01:37:48.484  1769  1769 I pppd    : Using interface ppp0
<span class="anchor" id="line-50-1"></span>05-11 01:37:48.484  1769  1769 I pppd    : Connect: ppp0 &lt;--&gt; 
<span class="anchor" id="line-51-1"></span>05-11 01:37:48.484  1769  1769 W pppd    : Overriding mtu 1500 to 1400
<span class="anchor" id="line-52-1"></span>05-11 01:37:48.484  1769  1769 W pppd    : Overriding mru 1500 to mtu value 1400
<span class="anchor" id="line-53-1"></span>05-11 01:37:51.473  1769  1769 I pppd    : CHAP authentication succeeded: Access granted
<span class="anchor" id="line-54-1"></span>05-11 01:37:51.474  1769  1769 I pppd    : CHAP authentication succeeded
<span class="anchor" id="line-55-1"></span>05-11 01:37:51.483  1769  1769 I pppd    : local  IP address 192.168.2.100
<span class="anchor" id="line-56-1"></span>05-11 01:37:51.483  1769  1769 I pppd    : remote IP address 192.168.2.1
<span class="anchor" id="line-57-1"></span>05-11 01:37:51.484  1769  1769 I pppd    : primary   DNS address 8.8.8.8
<span class="anchor" id="line-58-1"></span>05-11 01:37:51.484  1769  1769 I pppd    : secondary DNS address 8.8.4.4</pre><span class="anchor" id="line-554"></span><span class="anchor" id="line-555"></span><p class="line867">
</p><h2 id="Test_PPP">Test PPP</h2>
<span class="anchor" id="line-556"></span><span class="anchor" id="line-557"></span><p class="line867"><strong>NOTE</strong>:
 if you can't bring up ppp0 interface (i.e. you can't see ppp0 in 
"ifconfig" output on PC) -- reflash all Android images, reboot once 
Android is booted, and try again. It helps somehow (haven't figured why 
though). <span class="anchor" id="line-558"></span><span class="anchor" id="line-559"></span></p><p class="line874">Once PPTP or L2TP is up, we can test if everything works as expected. <span class="anchor" id="line-560"></span>In this test we will copy file over <tt class="backtick">ppp0</tt> interface (via TCP protocol), using <tt class="backtick">netcat</tt> tool. <span class="anchor" id="line-561"></span><span class="anchor" id="line-562"></span></p><p class="line867"><em>On Android</em>: test that PPP connection work <span class="anchor" id="line-563"></span><span class="anchor" id="line-564"></span><span class="anchor" id="line-565"></span></p><pre><span class="anchor" id="line-1-34"></span># ping -I ppp0 192.168.2.1</pre><span class="anchor" id="line-566"></span><span class="anchor" id="line-567"></span><p class="line867"><em>On Android</em>: start receiving file via PPP. You may also want to start <strong>Wireshark</strong> on PC (for <tt class="backtick">ppp0</tt> interface) to sniff TCP packets for file transfer. <span class="anchor" id="line-568"></span><span class="anchor" id="line-569"></span><span class="anchor" id="line-570"></span></p><pre><span class="anchor" id="line-1-35"></span># toybox nc -l -p 1234</pre><span class="anchor" id="line-571"></span><span class="anchor" id="line-572"></span><p class="line867"><em>On PC</em>: start transmitting file (<tt class="backtick">file.dat</tt> should contain some text message). <span class="anchor" id="line-573"></span><span class="anchor" id="line-574"></span><span class="anchor" id="line-575"></span></p><pre><span class="anchor" id="line-1-36"></span>$ cat file.dat | nc -w 3 192.168.2.100 1234</pre><span class="anchor" id="line-576"></span><span class="anchor" id="line-577"></span><p class="line874">Now you should see file content in console on Android side. <span class="anchor" id="line-578"></span>To kill <tt class="backtick">mtpd</tt> on Android, figure out <tt class="backtick">mtpd</tt> process ID: <span class="anchor" id="line-579"></span><span class="anchor" id="line-580"></span><span class="anchor" id="line-581"></span></p><pre><span class="anchor" id="line-1-37"></span># ps | grep mtpd</pre><span class="anchor" id="line-582"></span><span class="anchor" id="line-583"></span><p class="line874">And kill it: <span class="anchor" id="line-584"></span><span class="anchor" id="line-585"></span><span class="anchor" id="line-586"></span></p><pre><span class="anchor" id="line-1-38"></span># kill &lt;mtpd_pid&gt;</pre><span class="anchor" id="line-587"></span><span class="anchor" id="line-588"></span><p class="line867">
</p><h2 id="Testing_VPN_over_WiFi">Testing VPN over WiFi</h2>
<span class="anchor" id="line-589"></span><span class="anchor" id="line-590"></span><p class="line862">End
 user is supposed to enable VPN in Settings (UI), rather then 
configuring it in console. Also, Android devices usually connect to 
network over WiFi (instead of Ethernet way we used in this wiki). So in 
order to test end user use-case we will need two things: <span class="anchor" id="line-591"></span></p><ol type="1"><li><p class="line862">Some
 Android device with WiFi on board. It can be e.g. Google Pixel phone or
 HiKey960 development board. I will use HiKey960 further, as I have 
access to it. <span class="anchor" id="line-592"></span></p></li><li><p class="line862">L2TP
 server with WiFi access point. I'll just use my old L2TP server on 
laptop (as described in this wiki), but will bring up WiFi Access Point 
using hostapd daemon. <span class="anchor" id="line-593"></span><span class="anchor" id="line-594"></span></p></li></ol><p class="line867">
</p><h3 id="Configuring_WiFi_Access_Point">Configuring WiFi Access Point</h3>
<span class="anchor" id="line-595"></span><span class="anchor" id="line-596"></span><p class="line862">For
 Access Point we will use hostapd daemon. As DHCP server we will use 
dnsmasq (so that our host can provide IP address dynamically to Android 
device, otherwise WiFi connection won't work). <span class="anchor" id="line-597"></span><span class="anchor" id="line-598"></span></p><p class="line874">Further I will assume next parameters: <span class="anchor" id="line-599"></span><span class="anchor" id="line-600"></span></p><div><table><tbody><tr>  <td><p class="line862"> eth1 </p></td>
  <td><p class="line862"> ISP network (connected to internet) </p></td>
</tr>
<tr>  <td><span class="anchor" id="line-601"></span><p class="line862"> wlan2 </p></td>
  <td><p class="line862"> WiFi Access Point (local network with Android device) </p></td>
</tr>
<tr>  <td><span class="anchor" id="line-602"></span><p class="line862"> 192.168.0.1 </p></td>
  <td><p class="line862"> Access Point IP address (wlan2 on host) </p></td>
</tr>
<tr>  <td><span class="anchor" id="line-603"></span><p class="line862"> joe-laptop </p></td>
  <td><p class="line862"> host name (PC/laptop) </p></td>
</tr>
</tbody></table></div><span class="anchor" id="line-604"></span><span class="anchor" id="line-605"></span><p class="line862">First, check that your WiFi module actually supports Access Point feature: <span class="anchor" id="line-606"></span><span class="anchor" id="line-607"></span><span class="anchor" id="line-608"></span></p><pre><span class="anchor" id="line-1-39"></span># iw list</pre><span class="anchor" id="line-609"></span><span class="anchor" id="line-610"></span><p class="line874">You should see lines like this: <span class="anchor" id="line-611"></span><span class="anchor" id="line-612"></span><span class="anchor" id="line-613"></span><span class="anchor" id="line-614"></span><span class="anchor" id="line-615"></span><span class="anchor" id="line-616"></span><span class="anchor" id="line-617"></span></p><pre><span class="anchor" id="line-1-40"></span>        Supported interface modes:
<span class="anchor" id="line-2-14"></span>                 ...
<span class="anchor" id="line-3-12"></span>                 * AP
<span class="anchor" id="line-4-10"></span>                 ...</pre><span class="anchor" id="line-618"></span><span class="anchor" id="line-619"></span><p class="line874">"AP" means that Access Point mode is supported. <span class="anchor" id="line-620"></span><span class="anchor" id="line-621"></span></p><p class="line874">Install daemons: <span class="anchor" id="line-622"></span><span class="anchor" id="line-623"></span><span class="anchor" id="line-624"></span></p><pre><span class="anchor" id="line-1-41"></span># sudo aptitude install hostapd dnsmasq</pre><span class="anchor" id="line-625"></span><span class="anchor" id="line-626"></span><div><table><tbody><tr>  <td style="background-color: #FFFF00"><p class="line891"><strong>hostapd</strong> version I'm using: 2.6</p></td>
</tr>
</tbody></table></div><span class="anchor" id="line-627"></span><span class="anchor" id="line-628"></span><div><table><tbody><tr>  <td style="background-color: #FFFF00"><p class="line891"><strong>dnsmasq</strong> version I'm using: 2.79</p></td>
</tr>
</tbody></table></div><span class="anchor" id="line-629"></span><span class="anchor" id="line-630"></span><p class="line862">In <tt class="backtick">/etc/default/hostapd</tt> specify hostapd config file path: <span class="anchor" id="line-631"></span><span class="anchor" id="line-632"></span><span class="anchor" id="line-633"></span></p><pre><span class="anchor" id="line-1-42"></span>DAEMON_CONF="/etc/hostapd/hostapd.conf"</pre><span class="anchor" id="line-634"></span><span class="anchor" id="line-635"></span><p class="line862">In <tt class="backtick">/etc/hostapd/hostapd.conf</tt> provide Access Point configuration: <span class="anchor" id="line-636"></span><span class="anchor" id="line-637"></span><span class="anchor" id="line-638"></span><span class="anchor" id="line-639"></span><span class="anchor" id="line-640"></span><span class="anchor" id="line-641"></span><span class="anchor" id="line-642"></span><span class="anchor" id="line-643"></span><span class="anchor" id="line-644"></span><span class="anchor" id="line-645"></span><span class="anchor" id="line-646"></span><span class="anchor" id="line-647"></span><span class="anchor" id="line-648"></span><span class="anchor" id="line-649"></span><span class="anchor" id="line-650"></span><span class="anchor" id="line-651"></span><span class="anchor" id="line-652"></span><span class="anchor" id="line-653"></span><span class="anchor" id="line-654"></span><span class="anchor" id="line-655"></span><span class="anchor" id="line-656"></span><span class="anchor" id="line-657"></span></p><pre><span class="anchor" id="line-1-43"></span>interface=wlan2
<span class="anchor" id="line-2-15"></span>driver=nl80211
<span class="anchor" id="line-3-13"></span>logger_syslog=-1
<span class="anchor" id="line-4-11"></span>logger_syslog_level=2
<span class="anchor" id="line-5-10"></span>logger_stdout=-1
<span class="anchor" id="line-6-9"></span>logger_stdout_level=2
<span class="anchor" id="line-7-7"></span>ctrl_interface=/var/run/hostapd
<span class="anchor" id="line-8-6"></span>ctrl_interface_group=0
<span class="anchor" id="line-9-6"></span>ssid=joe-laptop
<span class="anchor" id="line-10-6"></span>country_code=UA
<span class="anchor" id="line-11-6"></span>hw_mode=g
<span class="anchor" id="line-12-6"></span>channel=6
<span class="anchor" id="line-13-5"></span>macaddr_acl=0
<span class="anchor" id="line-14-4"></span>auth_algs=1
<span class="anchor" id="line-15-4"></span>ieee80211n=1
<span class="anchor" id="line-16-3"></span>wpa=2
<span class="anchor" id="line-17-3"></span>wpa_passphrase=Boeing-737
<span class="anchor" id="line-18-3"></span>wpa_key_mgmt=WPA-PSK
<span class="anchor" id="line-19-3"></span>wpa_pairwise=TKIP
<span class="anchor" id="line-20-3"></span>rsn_pairwise=CCMP</pre><span class="anchor" id="line-658"></span><span class="anchor" id="line-659"></span><p class="line862">Change <tt class="backtick">interface</tt> to your WiFi interface, <tt class="backtick">ssid</tt> to your host name, <tt class="backtick">country_code</tt> to your country and <tt class="backtick">wpa_passphrase</tt> to Access Point WiFi password, accordingly. <span class="anchor" id="line-660"></span><span class="anchor" id="line-661"></span></p><p class="line862">In your <tt class="backtick">/etc/network/interfaces</tt>, configure Access Point interface: <span class="anchor" id="line-662"></span><span class="anchor" id="line-663"></span><span class="anchor" id="line-664"></span><span class="anchor" id="line-665"></span><span class="anchor" id="line-666"></span><span class="anchor" id="line-667"></span></p><pre><span class="anchor" id="line-1-44"></span>auto wlan2
<span class="anchor" id="line-2-16"></span>iface wlan2 inet static
<span class="anchor" id="line-3-14"></span>address 192.168.0.1
<span class="anchor" id="line-4-12"></span>netmask 255.255.255.0</pre><span class="anchor" id="line-668"></span><span class="anchor" id="line-669"></span><p class="line862">Be sure 192.168.0.1 is not used in other interface, e.g. in <tt class="backtick">eth0</tt>. Also make sure that <tt class="backtick">wlan2</tt> is not managed by NetworkManager. <span class="anchor" id="line-670"></span><span class="anchor" id="line-671"></span></p><p class="line862">Configure dnsmasq in <tt class="backtick">/etc/dnsmasq.conf</tt> for lending IP addresses via DHCP on <tt class="backtick">wlan2</tt> interface: <span class="anchor" id="line-672"></span><span class="anchor" id="line-673"></span><span class="anchor" id="line-674"></span><span class="anchor" id="line-675"></span><span class="anchor" id="line-676"></span><span class="anchor" id="line-677"></span><span class="anchor" id="line-678"></span><span class="anchor" id="line-679"></span><span class="anchor" id="line-680"></span><span class="anchor" id="line-681"></span><span class="anchor" id="line-682"></span></p><pre><span class="anchor" id="line-1-45"></span>server=8.8.8.8
<span class="anchor" id="line-2-17"></span>interface=wlan2
<span class="anchor" id="line-3-15"></span>no-hosts
<span class="anchor" id="line-4-13"></span>addn-hosts=/etc/hosts.dnsmasq
<span class="anchor" id="line-5-11"></span>dhcp-range=192.168.0.2,192.168.0.10,255.255.255.0,12h
<span class="anchor" id="line-6-10"></span>dhcp-option=3,192.168.0.1
<span class="anchor" id="line-7-8"></span>dhcp-option=6,192.168.0.1
<span class="anchor" id="line-8-7"></span>log-queries
<span class="anchor" id="line-9-7"></span>log-dhcp</pre><span class="anchor" id="line-683"></span><span class="anchor" id="line-684"></span><p class="line862">Create <tt class="backtick">/etc/hosts.dnsmasq</tt> file and put next line into it: <span class="anchor" id="line-685"></span><span class="anchor" id="line-686"></span><span class="anchor" id="line-687"></span></p><pre><span class="anchor" id="line-1-46"></span>192.168.0.1 joe-laptop</pre><span class="anchor" id="line-688"></span><span class="anchor" id="line-689"></span><p class="line874">Restart related services: <span class="anchor" id="line-690"></span><span class="anchor" id="line-691"></span><span class="anchor" id="line-692"></span><span class="anchor" id="line-693"></span><span class="anchor" id="line-694"></span><span class="anchor" id="line-695"></span></p><pre><span class="anchor" id="line-1-47"></span>$ sudo service networking stop
<span class="anchor" id="line-2-18"></span>$ sudo service networking start
<span class="anchor" id="line-3-16"></span>$ sudo service hostapd restart
<span class="anchor" id="line-4-14"></span>$ sudo service dnsmasq restart</pre><span class="anchor" id="line-696"></span><span class="anchor" id="line-697"></span><p class="line862">Forward internet from <tt class="backtick">eth1</tt> to <tt class="backtick">wlan2</tt> interface: <span class="anchor" id="line-698"></span><span class="anchor" id="line-699"></span><span class="anchor" id="line-700"></span><span class="anchor" id="line-701"></span></p><pre><span class="anchor" id="line-1-48"></span>$ sudo iptables --table nat --append POSTROUTING --out-interface eth1 -j MASQUERADE
<span class="anchor" id="line-2-19"></span>$ sudo iptables --append FORWARD --in-interface wlan2 -j ACCEPT</pre><span class="anchor" id="line-702"></span><span class="anchor" id="line-703"></span><p class="line867">
</p><h3 id="Enabling_VPN_on_device">Enabling VPN on device</h3>
<span class="anchor" id="line-704"></span><span class="anchor" id="line-705"></span><p class="line862">As a client, I used HiKey960 board with AOSP master and kernel v4.14. Build instructions: <a class="attachment" href="https://wiki-archive.linaro.org/LMG/Kernel/PPP?action=AttachFile&amp;do=view&amp;target=hikey-master-4.14.txt" title="">hikey-master-4.14.txt</a> <span class="anchor" id="line-706"></span><span class="anchor" id="line-707"></span></p><p class="line874">First of all, to be on the safe side, let's put SELinux into permissive mode. On device: <span class="anchor" id="line-708"></span><span class="anchor" id="line-709"></span><span class="anchor" id="line-710"></span></p><pre><span class="anchor" id="line-1-49"></span># setenforce 0</pre><span class="anchor" id="line-711"></span><span class="anchor" id="line-712"></span><p class="line862">In
 UI, connect device to your Access Point WiFi (in our case it'll be 
called "joe-laptop"). You should see "Connected" status. After this, you
 should see the Internet connection, if you have it on your laptop and 
forwarded it to device using <tt class="backtick">iptables</tt> commands above. Use browser to check that Internet works. <span class="anchor" id="line-713"></span><span class="anchor" id="line-714"></span></p><p class="line874">Now, on device open "Settings" in UI interface. Create new VPN connection like shown on this screenshot: <span class="anchor" id="line-715"></span><span class="anchor" id="line-716"></span></p><p class="line867"><img alt="vpn_settings.png" class="attachment" src="LMG_Kernel_PPP%20-%20Linaro%20Wiki%20Archive_files/PPP_006.png" title="vpn_settings.png" align="middle"> <span class="anchor" id="line-717"></span><span class="anchor" id="line-718"></span></p><p class="line862">These settings will lead to starting <tt class="backtick">racoon</tt> and <tt class="backtick">mtpd</tt> with the same parameters as in <a class="https" href="https://wiki.linaro.org/LMG/Kernel/PPP#Bring_up_L2TP">Bring up L2TP</a> section. <span class="anchor" id="line-719"></span><span class="anchor" id="line-720"></span></p><p class="line862">Connect to created VPN. You should see "Connected" status once it's connected. <tt class="backtick">ifconfig</tt> will show you <tt class="backtick">ppp0</tt> interface. Details about connection process could be found in <tt class="backtick">logcat</tt>. <span class="anchor" id="line-721"></span><span class="anchor" id="line-722"></span></p><p class="line874">Test VPN by pinging the VPN server from device: <span class="anchor" id="line-723"></span><span class="anchor" id="line-724"></span><span class="anchor" id="line-725"></span></p><pre><span class="anchor" id="line-1-50"></span># ping 192.168.2.1</pre><span class="anchor" id="line-726"></span><span class="anchor" id="line-727"></span><p class="line867">
</p><h2 id="Development_status">Development status</h2>
<span class="anchor" id="line-728"></span><span class="anchor" id="line-729"></span><p class="line862">In order to use upstream kernel implementation of L2TP, some changes were made to <tt class="backtick">mtpd</tt> and <tt class="backtick">pppd</tt> Android projects, as well as to kernel/configs project. All patches were merged in AOSP: <span class="anchor" id="line-730"></span><span class="anchor" id="line-731"></span></p><ul><li style="list-style-type:none"><p class="line891"><a class="https" href="https://android-review.googlesource.com/q/owner:semen.protsenko%2540linaro.org+status:merged">patches</a> <span class="anchor" id="line-732"></span><span class="anchor" id="line-733"></span></p></li></ul><p class="line874">If you want to try it out: <span class="anchor" id="line-734"></span></p><ul><li>build AOSP master (which has those patches merged) <span class="anchor" id="line-735"></span></li><li>build
 kernel (tested on v4.14); make sure to merge corresponding Android 
kernel/configs, where upstream L2TP is enabled (see patches in the link 
above) <span class="anchor" id="line-736"></span><span class="anchor" id="line-737"></span></li></ul><p class="line862">Then
 run L2TP VPN as usual. Upstream implementation (OL2TP) will be tried 
first; if it's not supported by your kernel, old OLAC implementation 
will be used (fall-back mechanism). Check your <tt class="backtick">logcat</tt> output to see details. <span class="anchor" id="line-738"></span><span class="anchor" id="line-739"></span></p><p class="line867">
</p><h2 id="Debugging_and_development_hints">Debugging and development hints</h2>
<span class="anchor" id="line-740"></span><span class="anchor" id="line-741"></span><p class="line874">Next projects may need to be debugged: <span class="anchor" id="line-742"></span></p><ol type="1"><li><p class="line891"><strong>xl2tpd</strong>: running on PC <span class="anchor" id="line-743"></span></p></li><li><p class="line891"><strong>mtpd</strong> (part of AFS): running on Android <span class="anchor" id="line-744"></span></p></li><li><p class="line891"><strong>kernel</strong> (L2TP/PPTP implementation): running on Android <span class="anchor" id="line-745"></span><span class="anchor" id="line-746"></span></p></li></ol><p class="line874">Further described some debugging techniques allow us to debug those projects.  <span class="anchor" id="line-747"></span><span class="anchor" id="line-748"></span></p><p class="line862">Also we can sniff packets via <tt class="backtick">eth0</tt> interface using Wireshark. <span class="anchor" id="line-749"></span><span class="anchor" id="line-750"></span></p><p class="line867">
</p><h3 id="Wireshark">Wireshark</h3>
<span class="anchor" id="line-751"></span><span class="anchor" id="line-752"></span><p class="line867">
</p><h4 id="Change_racoon_encoding_algorithm">Change racoon encoding algorithm</h4>
<span class="anchor" id="line-753"></span><span class="anchor" id="line-754"></span><p class="line862">In case of L2TP, traffic is encoded by <tt class="backtick">racoon</tt> server (IPSec), using one of next algorithms: <span class="anchor" id="line-755"></span></p><ul><li>DES <span class="anchor" id="line-756"></span></li><li>3DES <span class="anchor" id="line-757"></span></li><li>AES <span class="anchor" id="line-758"></span><span class="anchor" id="line-759"></span></li></ul><p class="line862">Previously we <a class="https" href="https://wiki.linaro.org/LMG/Kernel/PPP#racoon_configuration">configured</a> <tt class="backtick">racoon</tt>
 to use AES encryption, as it's the most secure of algorithms listed 
above. Unfortunately, Wireshark is not able (yet) to decrypt AES 
encrypted packets. So in order to decrypt packets, we need to change <tt class="backtick">racoon</tt> configuration to use either DES or 3DES algorithm. Let's stick to 3DES, as it's more secure. <span class="anchor" id="line-760"></span><span class="anchor" id="line-761"></span></p><p class="line862">Change <tt class="backtick">/etc/racoon/racoon.conf</tt>, so that <tt class="backtick">encryption_algorithm</tt> property is set to <tt class="backtick">3des</tt> in all sections. <span class="anchor" id="line-762"></span>Also, you can switch log level to <tt class="backtick">debug2</tt> (most verbose debug), so some extra information can be obtained further from <tt class="backtick">/var/log/syslog</tt>. <span class="anchor" id="line-763"></span><span class="anchor" id="line-764"></span></p><p class="line874">Modified config file should look like this: <span class="anchor" id="line-765"></span><span class="anchor" id="line-766"></span><span class="anchor" id="line-767"></span><span class="anchor" id="line-768"></span><span class="anchor" id="line-769"></span><span class="anchor" id="line-770"></span><span class="anchor" id="line-771"></span><span class="anchor" id="line-772"></span><span class="anchor" id="line-773"></span><span class="anchor" id="line-774"></span><span class="anchor" id="line-775"></span><span class="anchor" id="line-776"></span><span class="anchor" id="line-777"></span><span class="anchor" id="line-778"></span><span class="anchor" id="line-779"></span><span class="anchor" id="line-780"></span><span class="anchor" id="line-781"></span><span class="anchor" id="line-782"></span><span class="anchor" id="line-783"></span><span class="anchor" id="line-784"></span><span class="anchor" id="line-785"></span><span class="anchor" id="line-786"></span><span class="anchor" id="line-787"></span><span class="anchor" id="line-788"></span><span class="anchor" id="line-789"></span><span class="anchor" id="line-790"></span><span class="anchor" id="line-791"></span></p><pre><span class="anchor" id="line-1-51"></span>log debug2;
<span class="anchor" id="line-2-20"></span>path pre_shared_key "/etc/racoon/psk.txt";
<span class="anchor" id="line-3-17"></span>path certificate "/etc/racoon/certs";
<span class="anchor" id="line-4-15"></span>
<span class="anchor" id="line-5-12"></span>remote anonymous {
<span class="anchor" id="line-6-11"></span>        exchange_mode aggressive;
<span class="anchor" id="line-7-9"></span>
<span class="anchor" id="line-8-8"></span>        generate_policy on;
<span class="anchor" id="line-9-8"></span>        nat_traversal on;
<span class="anchor" id="line-10-7"></span>
<span class="anchor" id="line-11-7"></span>        dpd_delay 20;
<span class="anchor" id="line-12-7"></span>
<span class="anchor" id="line-13-6"></span>        proposal {
<span class="anchor" id="line-14-5"></span>                encryption_algorithm 3des;
<span class="anchor" id="line-15-5"></span>                hash_algorithm md5;
<span class="anchor" id="line-16-4"></span>                authentication_method pre_shared_key;
<span class="anchor" id="line-17-4"></span>                dh_group modp1024;
<span class="anchor" id="line-18-4"></span>        }
<span class="anchor" id="line-19-4"></span>}
<span class="anchor" id="line-20-4"></span>
<span class="anchor" id="line-21-3"></span>sainfo anonymous {
<span class="anchor" id="line-22-3"></span>        encryption_algorithm 3des;
<span class="anchor" id="line-23-3"></span>        authentication_algorithm hmac_sha1, hmac_md5;
<span class="anchor" id="line-24-3"></span>        compression_algorithm deflate;
<span class="anchor" id="line-25-3"></span>}</pre><span class="anchor" id="line-792"></span><span class="anchor" id="line-793"></span><p class="line862">Now, restart <tt class="backtick">racoon</tt> service: <span class="anchor" id="line-794"></span><span class="anchor" id="line-795"></span><span class="anchor" id="line-796"></span></p><pre><span class="anchor" id="line-1-52"></span># service racoon restart</pre><span class="anchor" id="line-797"></span><span class="anchor" id="line-798"></span><p class="line867">
</p><h4 id="Run_sniffing">Run sniffing</h4>
<span class="anchor" id="line-799"></span><span class="anchor" id="line-800"></span><p class="line862">Start Wireshark and run sniffing on <tt class="backtick">eth0</tt> protocol. <span class="anchor" id="line-801"></span><span class="anchor" id="line-802"></span></p><p class="line862">Start <tt class="backtick">racoon</tt> and <tt class="backtick">mtpd</tt> commands on Android device, as it's <a class="https" href="https://wiki.linaro.org/LMG/Kernel/PPP#Bring_up_L2TP">described</a> above. <span class="anchor" id="line-803"></span><span class="anchor" id="line-804"></span></p><p class="line874">Once packets of interest are caught -- stop sniffing. <span class="anchor" id="line-805"></span><span class="anchor" id="line-806"></span></p><p class="line867">
</p><h4 id="Figure_out_IPSec_keys">Figure out IPSec keys</h4>
<span class="anchor" id="line-807"></span><span class="anchor" id="line-808"></span><p class="line874">Run next command (from [8]): <span class="anchor" id="line-809"></span><span class="anchor" id="line-810"></span><span class="anchor" id="line-811"></span></p><pre><span class="anchor" id="line-1-53"></span># ip xfrm state</pre><span class="anchor" id="line-812"></span><span class="anchor" id="line-813"></span><p class="line862">It prints next params (for both "client -&gt; server" and "server -&gt; client" transmissions): <span class="anchor" id="line-814"></span></p><ul><li><p class="line862">SPI (<a class="https" href="https://en.wikipedia.org/wiki/Security_Parameter_Index">Security Parameter Index</a>) <span class="anchor" id="line-815"></span></p></li><li>Encryption Algorithm (we are using 3DES) <span class="anchor" id="line-816"></span></li><li>Encyption Key <span class="anchor" id="line-817"></span></li><li><p class="line862">Authentication Algorithm (it's <a class="https" href="https://en.wikipedia.org/wiki/Hash-based_message_authentication_code">HMAC</a> with <a class="https" href="https://en.wikipedia.org/wiki/SHA-1">SHA-1</a> as hash function, with <a class="https" href="https://en.wikipedia.org/wiki/Message_authentication_code">MAC</a> truncated to 96 bits) <span class="anchor" id="line-818"></span></p></li><li>Authentication Key <span class="anchor" id="line-819"></span><span class="anchor" id="line-820"></span></li></ul><p class="line867">
</p><h4 id="Decrypt_ESP_packets">Decrypt ESP packets</h4>
<span class="anchor" id="line-821"></span><span class="anchor" id="line-822"></span><p class="line874">We only want to decrypt ESP packets (as ISAKMP packets don't have any interesting information for us). <span class="anchor" id="line-823"></span><span class="anchor" id="line-824"></span></p><p class="line874">Enable ESP decryption in Wireshark: <span class="anchor" id="line-825"></span><span class="anchor" id="line-826"></span><span class="anchor" id="line-827"></span></p><pre><span class="anchor" id="line-1-54"></span>Edit -&gt; Preferences -&gt; Protocols -&gt; ESP -&gt; Attempt to detect/decode encrypted ESP payloads</pre><span class="anchor" id="line-828"></span><span class="anchor" id="line-829"></span><p class="line874">Now add the two ESP SAs (one for each direction), as shown on image below. <span class="anchor" id="line-830"></span>Use information obtained from <tt class="backtick">ip&nbsp;xfrm&nbsp;state</tt>. <span class="anchor" id="line-831"></span><span class="anchor" id="line-832"></span></p><p class="line867"><img alt="wireshark-esp.png" class="attachment" src="LMG_Kernel_PPP%20-%20Linaro%20Wiki%20Archive_files/PPP_004.png" title="wireshark-esp.png" align="middle"> <span class="anchor" id="line-833"></span><span class="anchor" id="line-834"></span></p><p class="line874">Apply
 changes and all ESP packets will become decrypted, changing their 
"Protocol" field to "L2TP", "PPP", etc, as it's shown on picture below. <span class="anchor" id="line-835"></span><span class="anchor" id="line-836"></span></p><p class="line867"><img alt="wireshark-decrypted.png" class="attachment" src="LMG_Kernel_PPP%20-%20Linaro%20Wiki%20Archive_files/PPP_002.png" title="wireshark-decrypted.png" align="middle">  <span class="anchor" id="line-837"></span><span class="anchor" id="line-838"></span></p><p class="line874">See more details on [8]. <span class="anchor" id="line-839"></span><span class="anchor" id="line-840"></span></p><p class="line867">
</p><h3 id="Debugging_x2ltpd">Debugging x2ltpd</h3>
<span class="anchor" id="line-841"></span><span class="anchor" id="line-842"></span><p class="line867">
</p><h4 id="Enable_verbose_logs">Enable verbose logs</h4>
<span class="anchor" id="line-843"></span><span class="anchor" id="line-844"></span><p class="line862">Add next lines to <tt class="backtick">/etc/xl2tpd/xl2tpd.conf</tt> file: <span class="anchor" id="line-845"></span><span class="anchor" id="line-846"></span><span class="anchor" id="line-847"></span><span class="anchor" id="line-848"></span><span class="anchor" id="line-849"></span><span class="anchor" id="line-850"></span><span class="anchor" id="line-851"></span><span class="anchor" id="line-852"></span><span class="anchor" id="line-853"></span><span class="anchor" id="line-854"></span><span class="anchor" id="line-855"></span><span class="anchor" id="line-856"></span></p><pre><span class="anchor" id="line-1-55"></span>[global]
<span class="anchor" id="line-2-21"></span>...
<span class="anchor" id="line-3-18"></span>debug avp = yes
<span class="anchor" id="line-4-16"></span>debug network = yes
<span class="anchor" id="line-5-13"></span>debug state = yes
<span class="anchor" id="line-6-12"></span>debug tunnel = yes
<span class="anchor" id="line-7-10"></span>
<span class="anchor" id="line-8-9"></span>[lns default]
<span class="anchor" id="line-9-9"></span>...
<span class="anchor" id="line-10-8"></span>ppp debug = yes</pre><span class="anchor" id="line-857"></span><span class="anchor" id="line-858"></span><p class="line862">It will make xl2tpd log messages more verbose. See <tt class="backtick">/var/log/syslog</tt> file for xl2tpd logs. <span class="anchor" id="line-859"></span><span class="anchor" id="line-860"></span></p><p class="line867">
</p><h4 id="Add_debug_code_to_xl2tpd">Add debug code to xl2tpd</h4>
<span class="anchor" id="line-861"></span><span class="anchor" id="line-862"></span><p class="line874">For further investigation one may need to change xl2tpd code (add some tracing messages, etc). <span class="anchor" id="line-863"></span>We need to be sure that next requirements are met: <span class="anchor" id="line-864"></span></p><ul><li>The same version of xl2tpd is used <span class="anchor" id="line-865"></span></li><li>Modified xl2tpd installed as Debian package <span class="anchor" id="line-866"></span></li><li><p class="line862">Previous xl2tpd removed, but config files should be left (use <tt class="backtick">remove</tt> command instead of <tt class="backtick">purge</tt> one) <span class="anchor" id="line-867"></span><span class="anchor" id="line-868"></span></p></li></ul><p class="line874">First of all, obtain xl2tpd sources: <span class="anchor" id="line-869"></span><span class="anchor" id="line-870"></span><span class="anchor" id="line-871"></span></p><pre><span class="anchor" id="line-1-56"></span>$ apt-get source xl2tpd</pre><span class="anchor" id="line-872"></span><span class="anchor" id="line-873"></span><p class="line874">Modify xl2tpd sources (add traces, etc). <span class="anchor" id="line-874"></span><span class="anchor" id="line-875"></span></p><p class="line874">Remove old xl2tpd from your system and install build dependencies for xl2tpd: <span class="anchor" id="line-876"></span><span class="anchor" id="line-877"></span><span class="anchor" id="line-878"></span><span class="anchor" id="line-879"></span><span class="anchor" id="line-880"></span></p><pre><span class="anchor" id="line-1-57"></span>$ sudo service xl2tpd stop
<span class="anchor" id="line-2-22"></span>$ sudo aptitude remove xl2tpd
<span class="anchor" id="line-3-19"></span>$ sudo aptitude build-dep xl2tpd</pre><span class="anchor" id="line-881"></span><span class="anchor" id="line-882"></span><p class="line874">Build xl2tpd and create deb-package: <span class="anchor" id="line-883"></span><span class="anchor" id="line-884"></span><span class="anchor" id="line-885"></span><span class="anchor" id="line-886"></span><span class="anchor" id="line-887"></span></p><pre><span class="anchor" id="line-1-58"></span>$ cd xl2tpd-1.3.6+dfsg/
<span class="anchor" id="line-2-23"></span>$ sudo debuild -b -uc -us
<span class="anchor" id="line-3-20"></span>$ cd ..</pre><span class="anchor" id="line-888"></span><span class="anchor" id="line-889"></span><p class="line874">Install built package: <span class="anchor" id="line-890"></span><span class="anchor" id="line-891"></span><span class="anchor" id="line-892"></span><span class="anchor" id="line-893"></span></p><pre><span class="anchor" id="line-1-59"></span>$ sudo dpkg -i xl2tpd_1.3.6+dfsg-3_amd64.deb
<span class="anchor" id="line-2-24"></span>$ sudo aptitude hold xl2tpd</pre><span class="anchor" id="line-894"></span><span class="anchor" id="line-895"></span><p class="line874">Finally, make sure that xl2tpd is running: <span class="anchor" id="line-896"></span><span class="anchor" id="line-897"></span><span class="anchor" id="line-898"></span></p><pre><span class="anchor" id="line-1-60"></span>$ sudo service xl2tpd start</pre><span class="anchor" id="line-899"></span><span class="anchor" id="line-900"></span><p class="line862">Now you should be able to catch your traces in <tt class="backtick">/var/log/syslog</tt>: <span class="anchor" id="line-901"></span><span class="anchor" id="line-902"></span><span class="anchor" id="line-903"></span></p><pre><span class="anchor" id="line-1-61"></span>$ sudo less /var/log/syslog</pre><span class="anchor" id="line-904"></span><span class="anchor" id="line-905"></span><p class="line867">
</p><h3 id="mtpd">mtpd</h3>
<span class="anchor" id="line-906"></span><span class="anchor" id="line-907"></span><p class="line874">Changes to mtpd code can be break down to next categories: <span class="anchor" id="line-908"></span></p><ul><li>adding new protocols (like PPTP and L2TP from mainline kernel) <span class="anchor" id="line-909"></span></li><li>adding traces and other debugging stuff <span class="anchor" id="line-910"></span><span class="anchor" id="line-911"></span></li></ul><p class="line867">
</p><h4 id="Debugging_mtpd">Debugging mtpd</h4>
<span class="anchor" id="line-912"></span><span class="anchor" id="line-913"></span><p class="line862">Added prints can be seen in <tt class="backtick">logcat</tt>: <span class="anchor" id="line-914"></span><span class="anchor" id="line-915"></span><span class="anchor" id="line-916"></span></p><pre><span class="anchor" id="line-1-62"></span># logcat -s mtpd:*</pre><span class="anchor" id="line-917"></span><span class="anchor" id="line-918"></span><p class="line867">
</p><h3 id="Kernel_.28on_Android_side.29">Kernel (on Android side)</h3>
<span class="anchor" id="line-919"></span><span class="anchor" id="line-920"></span><p class="line867">
</p><h4 id="l2tp_debugging">l2tp debugging</h4>
<span class="anchor" id="line-921"></span><span class="anchor" id="line-922"></span><p class="line862">At this point we are only interested in modifying this file: <tt class="backtick">net/l2tp/l2tp_ppp.c</tt>. <span class="anchor" id="line-923"></span>The
 only stuff we should add there is just trace prints (to figure out 
tunnel id, session id, point where things go wrong, etc). <span class="anchor" id="line-924"></span><span class="anchor" id="line-925"></span></p><p class="line874">Added
 printings can be seen in kernel log (on Android device). Issue next 
command if you can't see your prints at once (i.e. your log level is not
 sufficient): <span class="anchor" id="line-926"></span><span class="anchor" id="line-927"></span><span class="anchor" id="line-928"></span></p><pre><span class="anchor" id="line-1-63"></span># dmesg</pre><span class="anchor" id="line-929"></span><span class="anchor" id="line-930"></span><p class="line867">
</p><h4 id="Kernel_log_size">Kernel log size</h4>
<span class="anchor" id="line-931"></span><span class="anchor" id="line-932"></span><p class="line874">If
 you can see only last part of kernel log, log buffer size needs to be 
increased. For this next option should be set as follows: <span class="anchor" id="line-933"></span><span class="anchor" id="line-934"></span><span class="anchor" id="line-935"></span></p><pre><span class="anchor" id="line-1-64"></span>CONFIG_LOG_BUF_SHIFT=17</pre><span class="anchor" id="line-936"></span><span class="anchor" id="line-937"></span><p class="line867">
</p><h2 id="Development_issues">Development issues</h2>
<span class="anchor" id="line-938"></span><span class="anchor" id="line-939"></span><p class="line867">
</p><h3 id="A.22Can_not_find_tunnel.22_issue:_investigation">"Can not find tunnel" issue: investigation</h3>
<span class="anchor" id="line-940"></span><span class="anchor" id="line-941"></span><p class="line867"><a class="attachment" href="https://wiki-archive.linaro.org/LMG/Kernel/PPP?action=AttachFile&amp;do=view&amp;target=xl2tpd-logs-analysis.png" title="This picture">This picture</a> shows comparison of next logs: <span class="anchor" id="line-942"></span></p><ul><li>xl2tpd logs for mainline kernel L2TP implementation (on left) <span class="anchor" id="line-943"></span></li><li>xl2tpd logs for Android kernel L2TP implementation (on right) <span class="anchor" id="line-944"></span><span class="anchor" id="line-945"></span></li></ul><p class="line862">We can see from picture above that <tt class="backtick">st-&gt;ourtid</tt> and <tt class="backtick">tunnel</tt> values should be the same (like it's happening for Android L2TP implementation). But those values are different when using <a class="http" href="http://git.linaro.org/people/semen.protsenko/mtpd.git/blob/01265f20617e7f3ca041e55dbf557912a0ecebd5:/l2tp_up.c#l349">code that I added</a> to mtpd, which uses mainline kernel L2TP implementation.  <span class="anchor" id="line-946"></span>Because of this xl2tpd cannot find tunnel id in its list (see error in picture above). It's because I return <tt class="backtick">session_fd</tt> in <tt class="backtick">create_pppox()</tt> function <a class="http" href="http://git.linaro.org/people/semen.protsenko/mtpd.git/blob/01265f20617e7f3ca041e55dbf557912a0ecebd5:/l2tp_up.c#l413">here</a>. In case when I return <tt class="backtick">tunnel_fd</tt> instead of <tt class="backtick">session_fd</tt>
 -- those values are the same, but it's unable to transmit any data 
(it's basically because mainline kernel L2TP implementation only allows 
to send management commands via tunnel, and data is intended to be send 
via session). <span class="anchor" id="line-947"></span><span class="anchor" id="line-948"></span></p><p class="line862">In original mtpd code (<tt class="backtick">l2tp.c</tt>) there is only one socket <a class="http" href="http://git.linaro.org/people/semen.protsenko/mtpd.git/blob/01265f20617e7f3ca041e55dbf557912a0ecebd5:/l2tp.c#l349">being created</a> (<tt class="backtick">pppox</tt>). Further this socket FD is being <a class="http" href="http://git.linaro.org/people/semen.protsenko/mtpd.git/blob/01265f20617e7f3ca041e55dbf557912a0ecebd5:/mtpd.c#l306">passed</a> to pppd process as <tt class="backtick">pppox</tt> parameter. <a class="https" href="https://android.googlesource.com/platform/external/ppp/+/a263473d0d18736659607a8f2e178ee94cf3f989%5E!/">This</a> commit (for Android pppd implementation) handles <tt class="backtick">pppox</tt> parameter. <span class="anchor" id="line-949"></span><span class="anchor" id="line-950"></span></p><p class="line862">But for <a class="http" href="http://git.linaro.org/people/semen.protsenko/mtpd.git/blob/01265f20617e7f3ca041e55dbf557912a0ecebd5:/l2tp_up.c#l349">modified mtpd code</a> (which is using mainline kernel L2TP implementation) we need to pass 3 parameters to pppd: <span class="anchor" id="line-951"></span></p><ul><li><p class="line891"><tt class="backtick">session_fd</tt> <span class="anchor" id="line-952"></span></p></li><li><p class="line891"><tt class="backtick">tunnel_id</tt> <span class="anchor" id="line-953"></span></p></li><li><p class="line891"><tt class="backtick">session_id</tt> <span class="anchor" id="line-954"></span><span class="anchor" id="line-955"></span></p></li></ul><p class="line862">So my suspicion is that we have to port <a class="https" href="https://download.samba.org/pub/unpacked/ppp/pppd/plugins/pppol2tp/">pppol2tp plugin</a>
 to Android pppd implementation. After that mtpd should be modified so 
that it runs pppol2tp plugin and passes required parameters for L2TP to 
it. <span class="anchor" id="line-956"></span><span class="anchor" id="line-957"></span></p><p class="line867">
</p><h3 id="Byte_order_issues">Byte order issues</h3>
<span class="anchor" id="line-958"></span><span class="anchor" id="line-959"></span><p class="line874">pppol2tp
 plugin had to be ported, but it didn't fix the issue with erroneous 
tunnel IDs. It's basically because that issue was caused by wrong byte 
order in some variables in code. <span class="anchor" id="line-960"></span><span class="anchor" id="line-961"></span></p><p class="line862">So
 there were endianness issues preventing upstream L2TP implementation 
from properly working. "Wrong tunnel id" issue was caused exactly by 
wrong byte order. In fact, it can be seen by swapping bytes in picture 
from <a class="https" href="https://wiki.linaro.org/LMG/Kernel/PPP#A.22Can_not_find_tunnel.22_issue:_investigation">this</a> issue: <span class="anchor" id="line-962"></span><span class="anchor" id="line-963"></span><span class="anchor" id="line-964"></span><span class="anchor" id="line-965"></span></p><pre><span class="anchor" id="line-1-65"></span>correct tunnel id = 20061 = 0x4e5d
<span class="anchor" id="line-2-25"></span>wrong tunnel id   = 23886 = 0x5d4e</pre><span class="anchor" id="line-966"></span><span class="anchor" id="line-967"></span><p class="line867"><a class="https" href="https://wiki.linaro.org/LMG/Kernel/PPP#Wireshark">Decrypting</a> of packets in Wireshark helped to root cause the issue. <span class="anchor" id="line-968"></span><span class="anchor" id="line-969"></span></p><p class="line862">First of all, I noticed that in L2TP packets Wireshark shows correct tunnel ID, but in <tt class="backtick">logcat</tt> I see wrong values. <span class="anchor" id="line-970"></span>Here is the patches that fix that issue: <span class="anchor" id="line-971"></span></p><ul><li><p class="line891"><a class="http" href="http://git.linaro.org/people/semen.protsenko/mtpd.git/commit/c16c7f078fd00caaafd319a11b17969009122f84">patch #1</a> <span class="anchor" id="line-972"></span></p></li><li><p class="line891"><a class="http" href="http://git.linaro.org/people/semen.protsenko/mtpd.git/commit/d4bad1a7f159495f1e37aab7007ccb35d4468ab7">patch #2</a> <span class="anchor" id="line-973"></span><span class="anchor" id="line-974"></span></p></li></ul><p class="line874">Of course, those fixes didn't help me with actual issue, but helped me to figure out what was happening there. <span class="anchor" id="line-975"></span><span class="anchor" id="line-976"></span></p><p class="line862">Interesting
 thing is that I haven't thought about possible byte order issue in 
tunnel ID value before actually saw code which builds this value from 
bytes arrived from network (see <tt class="backtick">mtpd</tt> project, <tt class="backtick">l2tp_up.c</tt> file, <tt class="backtick">get_attribute_raw()</tt> function). <span class="anchor" id="line-977"></span><span class="anchor" id="line-978"></span></p><p class="line862">So next I checked all variables in <tt class="backtick">mtpd</tt>
 which were involved in network transactions, figured which byte order 
is used for those values and checked those variables usage throughout 
the whole code. When doing that I noticed, that I'm passing <tt class="backtick">tunnel_id</tt> and <tt class="backtick">session_id</tt>
 in network byte order (big endian) to pppol2tp plugin, when starting 
pppd. Ok, this is understandable, as in original L2TP code in mtpd they 
are not passing those IDs at all, so I just haven't thought about this 
possible issue at the time. Here is the patch that fixes this issue: <span class="anchor" id="line-979"></span></p><ul><li><p class="line891"><a class="http" href="http://git.linaro.org/people/semen.protsenko/mtpd.git/commit/37e0462721c94328b575364042e16df1a42ec1f7">patch #3</a> <span class="anchor" id="line-980"></span><span class="anchor" id="line-981"></span></p></li></ul><p class="line862">But
 issue still existed, so I continued to check variables. Next thing I 
found was wrong filling of L2TP structures for further passing to <tt class="backtick">connect()</tt>
 call (i.e. in network byte order instead of host byte order). Why I 
haven't noticed that and I haven't thought of such issue when coding -- 
it's just because Android implementation requires just the opposite byte
 order, so I basically just copied the code. Btw, neither documentation 
mentions which byte order should be used for each field. So the last 
patch which finally fixes last issue is here: <span class="anchor" id="line-982"></span></p><ul><li><p class="line891"><a class="http" href="http://git.linaro.org/people/semen.protsenko/mtpd.git/commit/3dca8411e7656dab5b227792f11b8aca3180450b">patch #4</a> <span class="anchor" id="line-983"></span><span class="anchor" id="line-984"></span></p></li></ul><p class="line862">With all patches listed I managed to run <tt class="backtick">mtpd</tt> with mainline implementation of L2TP (like it's described <a class="https" href="https://wiki.linaro.org/LMG/Kernel/PPP#Development_of_mtpd">here</a>, just be sure to configure network and run <tt class="backtick">racoon</tt> first: <a class="https" href="https://wiki.linaro.org/LMG/Kernel/PPP#Bring_up_Ethernet">link 1</a>, <a class="https" href="https://wiki.linaro.org/LMG/Kernel/PPP#Bring_up_L2TP">link 2</a>) and successfully run <a class="https" href="https://wiki.linaro.org/LMG/Kernel/PPP#Test_PPP">test</a> (copying file from PC to Android device via <tt class="backtick">ppp0</tt> interface). <span class="anchor" id="line-985"></span><span class="anchor" id="line-986"></span></p><p class="line867">
</p><h3 id="pppol2tp.so_is_32-bit_instead_of_64-bit">pppol2tp.so is 32-bit instead of 64-bit</h3>
<span class="anchor" id="line-987"></span><span class="anchor" id="line-988"></span><p class="line862">As part of transition my patches from Android-N to Android-O, I changed next lines in <tt class="backtick">external/ppp/pppd/Android.mk</tt>: <span class="anchor" id="line-989"></span><span class="anchor" id="line-990"></span><span class="anchor" id="line-991"></span><span class="anchor" id="line-992"></span><span class="anchor" id="line-993"></span></p><pre><span class="anchor" id="line-1-66"></span>-LOCAL_MODULE_PATH := $(TARGET_OUT_SHARED_LIBRARIES)/pppd/$(VER)
<span class="anchor" id="line-2-26"></span>-LOCAL_UNSTRIPPED_PATH := $(TARGET_OUT_SHARED_LIBRARIES_UNSTRIPPED)/pppd/$(VER)
<span class="anchor" id="line-3-21"></span>+LOCAL_MODULE_RELATIVE_PATH := pppd/$(VER)</pre><span class="anchor" id="line-994"></span><span class="anchor" id="line-995"></span><p class="line862">So now I have two versions of <tt class="backtick">pppol2tp.so</tt> plugin built, 32-bit and 64-bit one: <span class="anchor" id="line-996"></span><span class="anchor" id="line-997"></span><span class="anchor" id="line-998"></span><span class="anchor" id="line-999"></span></p><pre><span class="anchor" id="line-1-67"></span>/system/lib/pppd/2.4.7/pppol2tp.so
<span class="anchor" id="line-2-27"></span>/system/lib64/pppd/2.4.7/pppol2tp.so</pre><span class="anchor" id="line-1000"></span><span class="anchor" id="line-1001"></span><p class="line862">When trying to test <tt class="backtick">racoon</tt> + <tt class="backtick">mtpd</tt>, next error messages appeared in <tt class="backtick">logcat</tt>: <span class="anchor" id="line-1002"></span><span class="anchor" id="line-1003"></span><span class="anchor" id="line-1004"></span><span class="anchor" id="line-1005"></span><span class="anchor" id="line-1006"></span><span class="anchor" id="line-1007"></span><span class="anchor" id="line-1008"></span><span class="anchor" id="line-1009"></span><span class="anchor" id="line-1010"></span><span class="anchor" id="line-1011"></span><span class="anchor" id="line-1012"></span><span class="anchor" id="line-1013"></span></p><pre><span class="anchor" id="line-1-68"></span>I mtpd    : Starting pppd (tunnel_fd = 8, session_fd = 9)
<span class="anchor" id="line-2-28"></span>I mtpd    : Pppd started (pid = 2926)
<span class="anchor" id="line-3-22"></span>pppd: dlopen failed: "/system/lib/pppd/2.4.7/pppol2tp.so" is 32-bit instead of 64-bit
<span class="anchor" id="line-4-17"></span>pppd: Couldn't load plugin pppol2tp.so
<span class="anchor" id="line-5-14"></span>E pppd    : dlopen failed: "/system/lib/pppd/2.4.7/pppol2tp.so" is 32-bit instead of 64-bit
<span class="anchor" id="line-6-13"></span>E pppd    : Couldn't load plugin pppol2tp.so
<span class="anchor" id="line-7-11"></span>I mtpd    : Received signal 17
<span class="anchor" id="line-8-10"></span>I mtpd    : Pppd is terminated (status = 2)
<span class="anchor" id="line-9-10"></span>D mtpd    : Sending STOPCCN
<span class="anchor" id="line-10-9"></span>I mtpd    : Mtpd is terminated (status = 34)</pre><span class="anchor" id="line-1014"></span><span class="anchor" id="line-1015"></span><p class="line862">It was fixed with next patch (in <tt class="backtick">external/ppp/</tt>): <span class="anchor" id="line-1016"></span><span class="anchor" id="line-1017"></span><span class="anchor" id="line-1018"></span><span class="anchor" id="line-1019"></span><span class="anchor" id="line-1020"></span><span class="anchor" id="line-1021"></span><span class="anchor" id="line-1022"></span><span class="anchor" id="line-1023"></span><span class="anchor" id="line-1024"></span><span class="anchor" id="line-1025"></span><span class="anchor" id="line-1026"></span><span class="anchor" id="line-1027"></span><span class="anchor" id="line-1028"></span><span class="anchor" id="line-1029"></span><span class="anchor" id="line-1030"></span><span class="anchor" id="line-1031"></span><span class="anchor" id="line-1032"></span><span class="anchor" id="line-1033"></span><span class="anchor" id="line-1034"></span><span class="anchor" id="line-1035"></span><span class="anchor" id="line-1036"></span><span class="anchor" id="line-1037"></span><span class="anchor" id="line-1038"></span><span class="anchor" id="line-1039"></span><span class="anchor" id="line-1-1"></span></p><div class="highlight diff"><div class="codearea" dir="ltr" lang="en">
<script type="text/javascript">
function isnumbered(obj) {
  return obj.childNodes.length && obj.firstChild.childNodes.length && obj.firstChild.firstChild.className == 'LineNumber';
}
function nformat(num,chrs,add) {
  var nlen = Math.max(0,chrs-(''+num).length), res = '';
  while (nlen>0) { res += ' '; nlen-- }
  return res+num+add;
}
function addnumber(did, nstart, nstep) {
  var c = document.getElementById(did), l = c.firstChild, n = 1;
  if (!isnumbered(c)) {
    if (typeof nstart == 'undefined') nstart = 1;
    if (typeof nstep  == 'undefined') nstep = 1;
    var n = nstart;
    while (l != null) {
      if (l.tagName == 'SPAN') {
        var s = document.createElement('SPAN');
        var a = document.createElement('A');
        s.className = 'LineNumber';
        a.appendChild(document.createTextNode(nformat(n,4,'')));
        a.href = '#' + did + '_' + n;
        s.appendChild(a);
        s.appendChild(document.createTextNode(' '));
        n += nstep;
        if (l.childNodes.length) {
          l.insertBefore(s, l.firstChild);
        }
        else {
          l.appendChild(s);
        }
      }
      l = l.nextSibling;
    }
  }
  return false;
}
function remnumber(did) {
  var c = document.getElementById(did), l = c.firstChild;
  if (isnumbered(c)) {
    while (l != null) {
      if (l.tagName == 'SPAN' && l.firstChild.className == 'LineNumber') l.removeChild(l.firstChild);
      l = l.nextSibling;
    }
  }
  return false;
}
function togglenumber(did, nstart, nstep) {
  var c = document.getElementById(did);
  if (isnumbered(c)) {
    remnumber(did);
  } else {
    addnumber(did,nstart,nstep);
  }
  return false;
}
</script>

<script type="text/javascript">
document.write('<a href="#" onclick="return togglenumber(\'CA-2805036dbde1991ad50d6b649b8949ffdac33d39\', 1, 1);" \
                class="codenumbers">Toggle line numbers<\/a>');
</script>
<pre dir="ltr" id="CA-2805036dbde1991ad50d6b649b8949ffdac33d39" lang="en"><span class="line"><span class="LineNumber"><a href="#CA-2805036dbde1991ad50d6b649b8949ffdac33d39_1">   1</a> </span><span class="LineAnchor" id="CA-2805036dbde1991ad50d6b649b8949ffdac33d39_1"></span><span class="anchor" id="line-1-2"></span><span class="DiffRemoved">--- a/pppd/pathnames.h</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-2805036dbde1991ad50d6b649b8949ffdac33d39_2">   2</a> </span><span class="LineAnchor" id="CA-2805036dbde1991ad50d6b649b8949ffdac33d39_2"></span><span class="anchor" id="line-2-1"></span><span class="DiffRemoved"></span><span class="DiffAdded">+++ b/pppd/pathnames.h</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-2805036dbde1991ad50d6b649b8949ffdac33d39_3">   3</a> </span><span class="LineAnchor" id="CA-2805036dbde1991ad50d6b649b8949ffdac33d39_3"></span><span class="anchor" id="line-3-1"></span><span class="DiffAdded"></span><span class="DiffSeparator">@@ -55,11 +55,17 @@</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-2805036dbde1991ad50d6b649b8949ffdac33d39_4">   4</a> </span><span class="LineAnchor" id="CA-2805036dbde1991ad50d6b649b8949ffdac33d39_4"></span><span class="anchor" id="line-4-1"></span><span class="DiffSeparator"></span> #endif</span>
<span class="line"><span class="LineNumber"><a href="#CA-2805036dbde1991ad50d6b649b8949ffdac33d39_5">   5</a> </span><span class="LineAnchor" id="CA-2805036dbde1991ad50d6b649b8949ffdac33d39_5"></span><span class="anchor" id="line-5-1"></span> #endif /* __STDC__ */</span>
<span class="line"><span class="LineNumber"><a href="#CA-2805036dbde1991ad50d6b649b8949ffdac33d39_6">   6</a> </span><span class="LineAnchor" id="CA-2805036dbde1991ad50d6b649b8949ffdac33d39_6"></span><span class="anchor" id="line-6-1"></span> </span>
<span class="line"><span class="LineNumber"><a href="#CA-2805036dbde1991ad50d6b649b8949ffdac33d39_7">   7</a> </span><span class="LineAnchor" id="CA-2805036dbde1991ad50d6b649b8949ffdac33d39_7"></span><span class="anchor" id="line-7-1"></span><span class="DiffAdded">+#if defined(__LP64__)</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-2805036dbde1991ad50d6b649b8949ffdac33d39_8">   8</a> </span><span class="LineAnchor" id="CA-2805036dbde1991ad50d6b649b8949ffdac33d39_8"></span><span class="anchor" id="line-8-1"></span><span class="DiffAdded"></span><span class="DiffAdded">+#define LIB_DIR                "lib64"</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-2805036dbde1991ad50d6b649b8949ffdac33d39_9">   9</a> </span><span class="LineAnchor" id="CA-2805036dbde1991ad50d6b649b8949ffdac33d39_9"></span><span class="anchor" id="line-9-1"></span><span class="DiffAdded"></span><span class="DiffAdded">+#else</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-2805036dbde1991ad50d6b649b8949ffdac33d39_10">  10</a> </span><span class="LineAnchor" id="CA-2805036dbde1991ad50d6b649b8949ffdac33d39_10"></span><span class="anchor" id="line-10-1"></span><span class="DiffAdded"></span><span class="DiffAdded">+#define LIB_DIR                "lib"</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-2805036dbde1991ad50d6b649b8949ffdac33d39_11">  11</a> </span><span class="LineAnchor" id="CA-2805036dbde1991ad50d6b649b8949ffdac33d39_11"></span><span class="anchor" id="line-11-1"></span><span class="DiffAdded"></span><span class="DiffAdded">+#endif</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-2805036dbde1991ad50d6b649b8949ffdac33d39_12">  12</a> </span><span class="LineAnchor" id="CA-2805036dbde1991ad50d6b649b8949ffdac33d39_12"></span><span class="anchor" id="line-12-1"></span><span class="DiffAdded"></span><span class="DiffAdded">+</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-2805036dbde1991ad50d6b649b8949ffdac33d39_13">  13</a> </span><span class="LineAnchor" id="CA-2805036dbde1991ad50d6b649b8949ffdac33d39_13"></span><span class="anchor" id="line-13-1"></span><span class="DiffAdded"></span> #ifdef PLUGIN</span>
<span class="line"><span class="LineNumber"><a href="#CA-2805036dbde1991ad50d6b649b8949ffdac33d39_14">  14</a> </span><span class="LineAnchor" id="CA-2805036dbde1991ad50d6b649b8949ffdac33d39_14"></span><span class="anchor" id="line-14-1"></span> #ifdef __STDC__</span>
<span class="line"><span class="LineNumber"><a href="#CA-2805036dbde1991ad50d6b649b8949ffdac33d39_15">  15</a> </span><span class="LineAnchor" id="CA-2805036dbde1991ad50d6b649b8949ffdac33d39_15"></span><span class="anchor" id="line-15-1"></span><span class="DiffRemoved">-#define _PATH_PLUGIN   DESTDIR "/lib/pppd/" VERSION</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-2805036dbde1991ad50d6b649b8949ffdac33d39_16">  16</a> </span><span class="LineAnchor" id="CA-2805036dbde1991ad50d6b649b8949ffdac33d39_16"></span><span class="anchor" id="line-16-1"></span><span class="DiffRemoved"></span><span class="DiffAdded">+#define _PATH_PLUGIN   DESTDIR "/" LIB_DIR "/pppd/" VERSION</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-2805036dbde1991ad50d6b649b8949ffdac33d39_17">  17</a> </span><span class="LineAnchor" id="CA-2805036dbde1991ad50d6b649b8949ffdac33d39_17"></span><span class="anchor" id="line-17-1"></span><span class="DiffAdded"></span> #else /* __STDC__ */</span>
<span class="line"><span class="LineNumber"><a href="#CA-2805036dbde1991ad50d6b649b8949ffdac33d39_18">  18</a> </span><span class="LineAnchor" id="CA-2805036dbde1991ad50d6b649b8949ffdac33d39_18"></span><span class="anchor" id="line-18-1"></span><span class="DiffRemoved">-#define _PATH_PLUGIN   "/usr/lib/pppd"</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-2805036dbde1991ad50d6b649b8949ffdac33d39_19">  19</a> </span><span class="LineAnchor" id="CA-2805036dbde1991ad50d6b649b8949ffdac33d39_19"></span><span class="anchor" id="line-19-1"></span><span class="DiffRemoved"></span><span class="DiffAdded">+#define _PATH_PLUGIN   "/usr/" LIB_DIR "/pppd"</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-2805036dbde1991ad50d6b649b8949ffdac33d39_20">  20</a> </span><span class="LineAnchor" id="CA-2805036dbde1991ad50d6b649b8949ffdac33d39_20"></span><span class="anchor" id="line-20-1"></span><span class="DiffAdded"></span> #endif /* __STDC__ */</span>
<span class="line"><span class="LineNumber"><a href="#CA-2805036dbde1991ad50d6b649b8949ffdac33d39_21">  21</a> </span><span class="LineAnchor" id="CA-2805036dbde1991ad50d6b649b8949ffdac33d39_21"></span><span class="anchor" id="line-21-1"></span> </span>
<span class="line"><span class="LineNumber"><a href="#CA-2805036dbde1991ad50d6b649b8949ffdac33d39_22">  22</a> </span><span class="LineAnchor" id="CA-2805036dbde1991ad50d6b649b8949ffdac33d39_22"></span><span class="anchor" id="line-22-1"></span> #endif /* PLUGIN */</span>
</pre></div></div><span class="anchor" id="line-1040"></span><span class="anchor" id="line-1041"></span><p class="line867">
</p><h3 id="pppol2tp.so_is_not_building_on_fresh_Android_build">pppol2tp.so is not building on fresh Android build</h3>
<span class="anchor" id="line-1042"></span><span class="anchor" id="line-1043"></span><p class="line862">Since PPPoL2TP plugin was added to <tt class="backtick">external/ppp/pppd&nbsp;project</tt>, it has to be built, because <tt class="backtick">pppd</tt> uses <tt class="backtick">pppol2tp.so</tt> for L2TP protocol. So let's add <tt class="backtick">pppol2tp</tt> plugin to <tt class="backtick">LOCAL_REQUIRED_MODULES</tt> in <tt class="backtick">pppd</tt> executable definition (<tt class="backtick">Android.mk</tt> file): <span class="anchor" id="line-1044"></span><span class="anchor" id="line-1045"></span><span class="anchor" id="line-1046"></span><span class="anchor" id="line-1047"></span><span class="anchor" id="line-1048"></span><span class="anchor" id="line-1-3"></span></p><div class="highlight diff"><div class="codearea" dir="ltr" lang="en">
<script type="text/javascript">
document.write('<a href="#" onclick="return togglenumber(\'CA-6a3815b3cda20883cd4248f74c24783469084411\', 1, 1);" \
                class="codenumbers">Toggle line numbers<\/a>');
</script>
<pre dir="ltr" id="CA-6a3815b3cda20883cd4248f74c24783469084411" lang="en"><span class="line"><span class="LineNumber"><a href="#CA-6a3815b3cda20883cd4248f74c24783469084411_1">   1</a> </span><span class="LineAnchor" id="CA-6a3815b3cda20883cd4248f74c24783469084411_1"></span><span class="anchor" id="line-1-4"></span> LOCAL_MODULE:= pppd</span>
<span class="line"><span class="LineNumber"><a href="#CA-6a3815b3cda20883cd4248f74c24783469084411_2">   2</a> </span><span class="LineAnchor" id="CA-6a3815b3cda20883cd4248f74c24783469084411_2"></span><span class="anchor" id="line-2-2"></span><span class="DiffAdded">+LOCAL_REQUIRED_MODULES := pppol2tp</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-6a3815b3cda20883cd4248f74c24783469084411_3">   3</a> </span><span class="LineAnchor" id="CA-6a3815b3cda20883cd4248f74c24783469084411_3"></span><span class="anchor" id="line-3-2"></span><span class="DiffAdded"></span> include $(BUILD_EXECUTABLE)</span>
</pre></div></div><span class="anchor" id="line-1049"></span><span class="anchor" id="line-1050"></span><p class="line862">Another way to do that would be adding it to <tt class="backtick">LOCAL_SHARED_LIBRARIES</tt> variable of <tt class="backtick">pppd</tt> executable definition in <tt class="backtick">external/ppp/pppd/Android.mk</tt>, but it would lead to linking <tt class="backtick">pppd</tt> binary against <tt class="backtick">pppol2tp.so</tt>, which we don't want, as <tt class="backtick">pppol2tp.so</tt> is just a plugin and should be loaded via <tt class="backtick">dlopen()</tt> only when it's needed. <span class="anchor" id="line-1051"></span><span class="anchor" id="line-1052"></span></p><p class="line862">Also we could add it to <tt class="backtick">PRODUCT_PACKAGES</tt> variables in <tt class="backtick">build/target/product/*.mk</tt> files, but it's better to specify it as a dependency of <tt class="backtick">pppd</tt>, which it actually is, and not tinker with such a generic files like <tt class="backtick">build/...</tt>. <span class="anchor" id="line-1053"></span><span class="anchor" id="line-1054"></span></p><p class="line867">
</p><h3 id="pppol2tp.so_can.27t_be_loaded_by_Bionic_loader">pppol2tp.so can't be loaded by Bionic loader</h3>
<span class="anchor" id="line-1055"></span><span class="anchor" id="line-1056"></span><p class="line862">When PPPoL2TP plugin resides in <tt class="backtick">/system/lib[64]/pppd/2.4.7/</tt>, it can't be loaded with <tt class="backtick">dlopen()</tt> from <tt class="backtick">pppd</tt> binary, as this path is not in permitted path for default linker namespace. Next errors can be observed in <tt class="backtick">logcat</tt> output: <span class="anchor" id="line-1057"></span><span class="anchor" id="line-1058"></span><span class="anchor" id="line-1059"></span><span class="anchor" id="line-1060"></span><span class="anchor" id="line-1061"></span><span class="anchor" id="line-1062"></span><span class="anchor" id="line-1063"></span></p><pre><span class="anchor" id="line-1-69"></span>E linker  : library "/system/lib64/pppd/2.4.7/pppol2tp.so" ("/system/lib64/pppd/2.4.7/pppol2tp.so") needed or dlopened by "/system/bin/pppd" is not accessible for the namespace: [name="(default)", ld_library_paths="", default_library_paths="/system/lib64", permitted_paths="/system/lib64/drm:/system/lib64/hw:/system/framework:/system/app:/system/priv-app:/vendor/app:/vendor/framework:/oem/app:/data:/mnt/expand"]
<span class="anchor" id="line-2-29"></span>
<span class="anchor" id="line-3-23"></span>E pppd    : dlopen failed: library "/system/lib64/pppd/2.4.7/pppol2tp.so" needed or dlopened by "/system/bin/pppd" is not accessible for the namespace "(default)"
<span class="anchor" id="line-4-18"></span>
<span class="anchor" id="line-5-15"></span>E pppd    : Couldn't load plugin pppol2tp.so</pre><span class="anchor" id="line-1064"></span><span class="anchor" id="line-1065"></span><p class="line862">To fix this, let's install the <tt class="backtick">pppol2tp.so</tt> in root of <tt class="backtick">/system/lib[64]/</tt> without <tt class="backtick">pppd/2.4.7/</tt> sub-path, and make <tt class="backtick">pppd</tt> to look there for plugins too: <span class="anchor" id="line-1066"></span><span class="anchor" id="line-1067"></span><span class="anchor" id="line-1068"></span><span class="anchor" id="line-1069"></span><span class="anchor" id="line-1070"></span><span class="anchor" id="line-1071"></span><span class="anchor" id="line-1072"></span><span class="anchor" id="line-1073"></span><span class="anchor" id="line-1074"></span><span class="anchor" id="line-1075"></span><span class="anchor" id="line-1076"></span><span class="anchor" id="line-1077"></span><span class="anchor" id="line-1078"></span><span class="anchor" id="line-1079"></span><span class="anchor" id="line-1080"></span><span class="anchor" id="line-1081"></span><span class="anchor" id="line-1082"></span><span class="anchor" id="line-1083"></span><span class="anchor" id="line-1084"></span><span class="anchor" id="line-1085"></span><span class="anchor" id="line-1086"></span><span class="anchor" id="line-1-5"></span></p><div class="highlight diff"><div class="codearea" dir="ltr" lang="en">
<script type="text/javascript">
document.write('<a href="#" onclick="return togglenumber(\'CA-6bcd57d880ee552f8c4b3c4c38c7bf4908c26aed\', 1, 1);" \
                class="codenumbers">Toggle line numbers<\/a>');
</script>
<pre dir="ltr" id="CA-6bcd57d880ee552f8c4b3c4c38c7bf4908c26aed" lang="en"><span class="line"><span class="LineNumber"><a href="#CA-6bcd57d880ee552f8c4b3c4c38c7bf4908c26aed_1">   1</a> </span><span class="LineAnchor" id="CA-6bcd57d880ee552f8c4b3c4c38c7bf4908c26aed_1"></span><span class="anchor" id="line-1-6"></span><span class="DiffRemoved">--- a/pppd/Android.mk</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-6bcd57d880ee552f8c4b3c4c38c7bf4908c26aed_2">   2</a> </span><span class="LineAnchor" id="CA-6bcd57d880ee552f8c4b3c4c38c7bf4908c26aed_2"></span><span class="anchor" id="line-2-3"></span><span class="DiffRemoved"></span><span class="DiffAdded">+++ b/pppd/Android.mk</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-6bcd57d880ee552f8c4b3c4c38c7bf4908c26aed_3">   3</a> </span><span class="LineAnchor" id="CA-6bcd57d880ee552f8c4b3c4c38c7bf4908c26aed_3"></span><span class="anchor" id="line-3-3"></span><span class="DiffAdded"></span></span>
<span class="line"><span class="LineNumber"><a href="#CA-6bcd57d880ee552f8c4b3c4c38c7bf4908c26aed_4">   4</a> </span><span class="LineAnchor" id="CA-6bcd57d880ee552f8c4b3c4c38c7bf4908c26aed_4"></span><span class="anchor" id="line-4-2"></span> include $(CLEAR_VARS)</span>
<span class="line"><span class="LineNumber"><a href="#CA-6bcd57d880ee552f8c4b3c4c38c7bf4908c26aed_5">   5</a> </span><span class="LineAnchor" id="CA-6bcd57d880ee552f8c4b3c4c38c7bf4908c26aed_5"></span><span class="anchor" id="line-5-2"></span> LOCAL_MODULE := pppol2tp</span>
<span class="line"><span class="LineNumber"><a href="#CA-6bcd57d880ee552f8c4b3c4c38c7bf4908c26aed_6">   6</a> </span><span class="LineAnchor" id="CA-6bcd57d880ee552f8c4b3c4c38c7bf4908c26aed_6"></span><span class="anchor" id="line-6-2"></span><span class="DiffRemoved">-VER := $(shell awk -F '"' '/VERSION/ { print $$2; }' $(LOCAL_PATH)/patchlevel.h)</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-6bcd57d880ee552f8c4b3c4c38c7bf4908c26aed_7">   7</a> </span><span class="LineAnchor" id="CA-6bcd57d880ee552f8c4b3c4c38c7bf4908c26aed_7"></span><span class="anchor" id="line-7-2"></span><span class="DiffRemoved"></span><span class="DiffRemoved">-LOCAL_MODULE_RELATIVE_PATH := pppd/$(VER)</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-6bcd57d880ee552f8c4b3c4c38c7bf4908c26aed_8">   8</a> </span><span class="LineAnchor" id="CA-6bcd57d880ee552f8c4b3c4c38c7bf4908c26aed_8"></span><span class="anchor" id="line-8-2"></span><span class="DiffRemoved"></span></span>
<span class="line"><span class="LineNumber"><a href="#CA-6bcd57d880ee552f8c4b3c4c38c7bf4908c26aed_9">   9</a> </span><span class="LineAnchor" id="CA-6bcd57d880ee552f8c4b3c4c38c7bf4908c26aed_9"></span><span class="anchor" id="line-9-2"></span><span class="DiffRemoved">--- a/pppd/pathnames.h</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-6bcd57d880ee552f8c4b3c4c38c7bf4908c26aed_10">  10</a> </span><span class="LineAnchor" id="CA-6bcd57d880ee552f8c4b3c4c38c7bf4908c26aed_10"></span><span class="anchor" id="line-10-2"></span><span class="DiffRemoved"></span><span class="DiffAdded">+++ b/pppd/pathnames.h</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-6bcd57d880ee552f8c4b3c4c38c7bf4908c26aed_11">  11</a> </span><span class="LineAnchor" id="CA-6bcd57d880ee552f8c4b3c4c38c7bf4908c26aed_11"></span><span class="anchor" id="line-11-2"></span><span class="DiffAdded"></span> </span>
<span class="line"><span class="LineNumber"><a href="#CA-6bcd57d880ee552f8c4b3c4c38c7bf4908c26aed_12">  12</a> </span><span class="LineAnchor" id="CA-6bcd57d880ee552f8c4b3c4c38c7bf4908c26aed_12"></span><span class="anchor" id="line-12-2"></span> #ifdef PLUGIN</span>
<span class="line"><span class="LineNumber"><a href="#CA-6bcd57d880ee552f8c4b3c4c38c7bf4908c26aed_13">  13</a> </span><span class="LineAnchor" id="CA-6bcd57d880ee552f8c4b3c4c38c7bf4908c26aed_13"></span><span class="anchor" id="line-13-2"></span> #ifdef __STDC__</span>
<span class="line"><span class="LineNumber"><a href="#CA-6bcd57d880ee552f8c4b3c4c38c7bf4908c26aed_14">  14</a> </span><span class="LineAnchor" id="CA-6bcd57d880ee552f8c4b3c4c38c7bf4908c26aed_14"></span><span class="anchor" id="line-14-2"></span><span class="DiffRemoved">-#define _PATH_PLUGIN   DESTDIR "/" LIB_DIR "/pppd/" VERSION</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-6bcd57d880ee552f8c4b3c4c38c7bf4908c26aed_15">  15</a> </span><span class="LineAnchor" id="CA-6bcd57d880ee552f8c4b3c4c38c7bf4908c26aed_15"></span><span class="anchor" id="line-15-2"></span><span class="DiffRemoved"></span><span class="DiffAdded">+#define _PATH_PLUGIN   DESTDIR "/" LIB_DIR</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-6bcd57d880ee552f8c4b3c4c38c7bf4908c26aed_16">  16</a> </span><span class="LineAnchor" id="CA-6bcd57d880ee552f8c4b3c4c38c7bf4908c26aed_16"></span><span class="anchor" id="line-16-2"></span><span class="DiffAdded"></span> #else /* __STDC__ */</span>
<span class="line"><span class="LineNumber"><a href="#CA-6bcd57d880ee552f8c4b3c4c38c7bf4908c26aed_17">  17</a> </span><span class="LineAnchor" id="CA-6bcd57d880ee552f8c4b3c4c38c7bf4908c26aed_17"></span><span class="anchor" id="line-17-2"></span><span class="DiffRemoved">-#define _PATH_PLUGIN   "/usr/" LIB_DIR "/pppd"</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-6bcd57d880ee552f8c4b3c4c38c7bf4908c26aed_18">  18</a> </span><span class="LineAnchor" id="CA-6bcd57d880ee552f8c4b3c4c38c7bf4908c26aed_18"></span><span class="anchor" id="line-18-2"></span><span class="DiffRemoved"></span><span class="DiffAdded">+#define _PATH_PLUGIN   "/usr/" LIB_DIR</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-6bcd57d880ee552f8c4b3c4c38c7bf4908c26aed_19">  19</a> </span><span class="LineAnchor" id="CA-6bcd57d880ee552f8c4b3c4c38c7bf4908c26aed_19"></span><span class="anchor" id="line-19-2"></span><span class="DiffAdded"></span> #endif /* __STDC__ */</span>
</pre></div></div><span class="anchor" id="line-1087"></span><span class="anchor" id="line-1088"></span><p class="line862">See <tt class="backtick">/etc/ld.config.txt</tt> file on the board for Bionic loader configuration. In Android sources, there are three variants of <tt class="backtick">ld.config.txt</tt> files (in <tt class="backtick">system/core/rootdir/etc</tt>): <span class="anchor" id="line-1089"></span></p><ol type="1"><li><p class="line891"><tt class="backtick">ld.config.legacy.txt</tt>: for non-Treble-ized devices (<tt class="backtick">PRODUCT_TREBLE_LINKER_NAMESPACES</tt> is false) <span class="anchor" id="line-1090"></span></p></li><li><p class="line891"><tt class="backtick">ld.config.txt</tt>: for Treble-ized devices (<tt class="backtick">PRODUCT_TREBLE_LINKER_NAMESPACES</tt> is true) but without strict linker namespace restriction (<tt class="backtick">BOARD_VNDK_RUNTIME_DISABLE</tt> is true) <span class="anchor" id="line-1091"></span></p></li><li><p class="line891"><tt class="backtick">ld.config.txt.in</tt>: for Treble-ized devices with strict linker namespace restriction <span class="anchor" id="line-1092"></span><span class="anchor" id="line-1093"></span></p></li></ol><p class="line874">Only 3rd option can cause the described problem. The lib can't be loaded because: <span class="anchor" id="line-1094"></span></p><ul><li style="list-style-type:none">- the default namespace is configured as 'isolated' and <span class="anchor" id="line-1095"></span><p class="line862">- <tt class="backtick">system/${LIB}/pppd</tt> is not in the permitted paths of the default namespace <span class="anchor" id="line-1096"></span><span class="anchor" id="line-1097"></span></p></li></ul><p class="line874">Possible solutions: <span class="anchor" id="line-1098"></span></p><ol type="1"><li><p class="line862">Add <tt class="backtick">/system/${LIB}/pppd</tt> to <tt class="backtick">namespace.default.permitted.paths</tt> or <span class="anchor" id="line-1099"></span></p></li><li><p class="line862">Move your lib under <tt class="backtick">/system/lib64</tt> (or under other paths in <tt class="backtick">permitted.paths</tt>) <span class="anchor" id="line-1100"></span><span class="anchor" id="line-1101"></span></p></li></ol><p class="line874">I've chosen 2nd one, as it doesn't require changing any linker files, and it's gonna work in all three cases mentioned above. <span class="anchor" id="line-1102"></span><span class="anchor" id="line-1103"></span></p><p class="line867">
</p><h2 id="Issues_running_L2TP.2B-IPSec_on_Android-N">Issues running L2TP+IPSec on Android-N</h2>
<span class="anchor" id="line-1104"></span><span class="anchor" id="line-1105"></span><p class="line874">When
 trying to run racoon+mtpd on Android-N, I faced with a bunch of issues.
 All those issues are listed below. Solutions are provided as well. <span class="anchor" id="line-1106"></span><span class="anchor" id="line-1107"></span></p><p class="line867">
</p><h3 id="A.22Network_is_unreachable.22_issue">"Network is unreachable" issue</h3>
<span class="anchor" id="line-1108"></span><span class="anchor" id="line-1109"></span><p class="line874">After configuring the Ethernet connection, I tried to ping my laptop from Android: <span class="anchor" id="line-1110"></span><span class="anchor" id="line-1111"></span><span class="anchor" id="line-1112"></span></p><pre><span class="anchor" id="line-1-70"></span># ping 192.168.0.1</pre><span class="anchor" id="line-1113"></span><span class="anchor" id="line-1114"></span><p class="line862">which gave me this error: <tt class="backtick">connect:&nbsp;Network&nbsp;is&nbsp;unreachable</tt>. The only way to overcome that was running <tt class="backtick">ping&nbsp;-I&nbsp;eth0&nbsp;192.168.0.1</tt>, but that of course won't cut it (as we need to rely on eth0 as default interface for further PPP work). <span class="anchor" id="line-1115"></span><span class="anchor" id="line-1116"></span></p><p class="line862">Turns out, all <tt class="backtick">ip&nbsp;route</tt> commands we ran, they were changing only main routing table (<tt class="backtick">ip&nbsp;route&nbsp;show</tt> is actually <tt class="backtick">ip&nbsp;route&nbsp;show&nbsp;table&nbsp;main</tt>). And main routing table has lowest priority (look at <tt class="backtick">ip&nbsp;rule&nbsp;show</tt>
 command output, it's 23000 priority or even missing there). Setting the
 higher priority for main routing table solves the problem: <span class="anchor" id="line-1117"></span><span class="anchor" id="line-1118"></span><span class="anchor" id="line-1119"></span></p><pre><span class="anchor" id="line-1-71"></span># ip rule add from all lookup main pref 99</pre><span class="anchor" id="line-1120"></span><span class="anchor" id="line-1121"></span><p class="line874">After that we can check it: <span class="anchor" id="line-1122"></span><span class="anchor" id="line-1123"></span><span class="anchor" id="line-1124"></span></p><pre><span class="anchor" id="line-1-72"></span># ip rule show</pre><span class="anchor" id="line-1125"></span><span class="anchor" id="line-1126"></span><p class="line874">will show us something like this: <span class="anchor" id="line-1127"></span><span class="anchor" id="line-1128"></span><span class="anchor" id="line-1129"></span><span class="anchor" id="line-1130"></span><span class="anchor" id="line-1131"></span><span class="anchor" id="line-1132"></span><span class="anchor" id="line-1133"></span><span class="anchor" id="line-1134"></span><span class="anchor" id="line-1135"></span><span class="anchor" id="line-1136"></span><span class="anchor" id="line-1137"></span><span class="anchor" id="line-1138"></span><span class="anchor" id="line-1139"></span><span class="anchor" id="line-1140"></span><span class="anchor" id="line-1141"></span></p><pre><span class="anchor" id="line-1-73"></span>0:      from all lookup local
<span class="anchor" id="line-2-30"></span>99:     from all lookup main
<span class="anchor" id="line-3-24"></span>10000:  from all fwmark 0xc0000/0xd0000 lookup legacy_system
<span class="anchor" id="line-4-19"></span>10500:  from all oif eth0 uidrange 0-0 lookup eth0
<span class="anchor" id="line-5-16"></span>13000:  from all fwmark 0x10063/0x1ffff lookup local_network
<span class="anchor" id="line-6-14"></span>13000:  from all fwmark 0x10064/0x1ffff lookup eth0
<span class="anchor" id="line-7-12"></span>14000:  from all oif eth0 lookup eth0
<span class="anchor" id="line-8-11"></span>15000:  from all fwmark 0x0/0x10000 lookup legacy_system
<span class="anchor" id="line-9-11"></span>16000:  from all fwmark 0x0/0x10000 lookup legacy_network
<span class="anchor" id="line-10-10"></span>17000:  from all fwmark 0x0/0x10000 lookup local_network
<span class="anchor" id="line-11-8"></span>19000:  from all fwmark 0x64/0x1ffff lookup eth0
<span class="anchor" id="line-12-8"></span>22000:  from all fwmark 0x0/0xffff lookup eth0
<span class="anchor" id="line-13-7"></span>32000:  from all unreachable</pre><span class="anchor" id="line-1142"></span><span class="anchor" id="line-1143"></span><p class="line874">where you can see main routing table with highest priority. Now ping command works just fine. <span class="anchor" id="line-1144"></span><span class="anchor" id="line-1145"></span></p><p class="line874">Above fix should also allow non-root user to use eth0 interface. <span class="anchor" id="line-1146"></span><span class="anchor" id="line-1147"></span></p><p class="line867">
</p><h3 id="PSK_permissions_issue">PSK permissions issue</h3>
<span class="anchor" id="line-1148"></span><span class="anchor" id="line-1149"></span><p class="line862">racoon refuses to start, and reason is found in <tt class="backtick">/var/log/daemon.log</tt>: <span class="anchor" id="line-1150"></span><span class="anchor" id="line-1151"></span><span class="anchor" id="line-1152"></span></p><pre><span class="anchor" id="line-1-74"></span>ERROR: /etc/racoon/psk.txt has weak file permission</pre><span class="anchor" id="line-1153"></span><span class="anchor" id="line-1154"></span><p class="line867"><strong>FIX</strong>: The issue is fixed by changing mode of mentioned file: <span class="anchor" id="line-1155"></span><span class="anchor" id="line-1156"></span><span class="anchor" id="line-1157"></span></p><pre><span class="anchor" id="line-1-75"></span>$ sudo chmod 0400 /etc/racoon/psk.txt</pre><span class="anchor" id="line-1158"></span><span class="anchor" id="line-1159"></span><p class="line867">
</p><h3 id="A.22authtype_mismatched.22_issue">"authtype mismatched" issue</h3>
<span class="anchor" id="line-1160"></span><span class="anchor" id="line-1161"></span><p class="line867"><tt class="backtick">logcat</tt> shows next line, when trying to run <tt class="backtick">racoon</tt>: <span class="anchor" id="line-1162"></span><span class="anchor" id="line-1163"></span><span class="anchor" id="line-1164"></span></p><pre><span class="anchor" id="line-1-76"></span>W racoon  : authtype mismatched: my:hmac-sha256 peer:hmac-sha</pre><span class="anchor" id="line-1165"></span><span class="anchor" id="line-1166"></span><p class="line867"><strong>FIX</strong>: In <tt class="backtick">/etc/racoon/racoon.conf</tt>: change this line: <span class="anchor" id="line-1167"></span><span class="anchor" id="line-1168"></span><span class="anchor" id="line-1169"></span></p><pre><span class="anchor" id="line-1-77"></span>authentication_algorithm hmac_sha1, hmac_md5;</pre><span class="anchor" id="line-1170"></span><span class="anchor" id="line-1171"></span><p class="line874">to this: <span class="anchor" id="line-1172"></span><span class="anchor" id="line-1173"></span><span class="anchor" id="line-1174"></span></p><pre><span class="anchor" id="line-1-78"></span>authentication_algorithm hmac_sha256, hmac_md5;</pre><span class="anchor" id="line-1175"></span><span class="anchor" id="line-1176"></span><p class="line867"><em>Supplemental</em>: it turned out, that this issue is not critical, in the end. VPN will work with <tt class="backtick">hmac_sha1</tt>, too. But let's use <tt class="backtick">hmac_sha256</tt> just to avoid that warning. <span class="anchor" id="line-1177"></span><span class="anchor" id="line-1178"></span></p><p class="line874">Also, some other guys are experiencing issues with SHA2 implementation in Android: [9]. <span class="anchor" id="line-1179"></span><span class="anchor" id="line-1180"></span></p><p class="line874">But it seems like my configuration (described at this wiki page) is not prone to that issue. <span class="anchor" id="line-1181"></span><span class="anchor" id="line-1182"></span></p><p class="line867">
</p><h3 id="A.22pfkey_failed.22_racoon_issue">"pfkey failed" racoon issue</h3>
<span class="anchor" id="line-1183"></span><span class="anchor" id="line-1184"></span><p class="line862">When running <tt class="backtick">racoon</tt> + <tt class="backtick">mtpd</tt>, I observe next issues in <tt class="backtick">logcat</tt>: <span class="anchor" id="line-1185"></span><span class="anchor" id="line-1186"></span><span class="anchor" id="line-1187"></span><span class="anchor" id="line-1188"></span></p><pre><span class="anchor" id="line-1-79"></span>pfkey UPDATE failed: No such file or directory
<span class="anchor" id="line-2-31"></span>pfkey ADD failed: No such file or directory</pre><span class="anchor" id="line-1189"></span><span class="anchor" id="line-1190"></span><p class="line862">The cause most probably (related to what I found on internet) is that <tt class="backtick">AUTHENC</tt> module is not loaded in kernel. But I've got <tt class="backtick">CONFIG_CRYPTO_AUTHENC=y</tt> in my <tt class="backtick">.config</tt> file. <span class="anchor" id="line-1191"></span><span class="anchor" id="line-1192"></span></p><p class="line862">When I look into <tt class="backtick">/proc/crypto</tt>, I don't see <tt class="backtick">authenc</tt> module in list (but I see it in my PC's <tt class="backtick">/proc/crypto</tt>). So it's not loaded somehow. <tt class="backtick">/proc/crypto</tt> has entries like that: <tt class="backtick">kmod="crypto-ctr(aes)"</tt>, where: <span class="anchor" id="line-1193"></span><span class="anchor" id="line-1194"></span></p><ul><li><p class="line891"><tt class="backtick">aes</tt> is cipher <span class="anchor" id="line-1195"></span></p></li><li><p class="line891"><tt class="backtick">ctr</tt> is template  <span class="anchor" id="line-1196"></span><span class="anchor" id="line-1197"></span></p></li></ul><p class="line862">See <a class="https" href="https://kernel.readthedocs.io/en/sphinx-samples/crypto-API.html">this</a> for details. <span class="anchor" id="line-1198"></span><span class="anchor" id="line-1199"></span></p><p class="line867"><tt class="backtick">AUTHENC</tt> module is trying to be loaded when starting <tt class="backtick">mtpd</tt>: <span class="anchor" id="line-1200"></span><span class="anchor" id="line-1201"></span><span class="anchor" id="line-1202"></span><span class="anchor" id="line-1203"></span><span class="anchor" id="line-1204"></span><span class="anchor" id="line-1205"></span><span class="anchor" id="line-1206"></span><span class="anchor" id="line-1207"></span></p><pre><span class="anchor" id="line-1-80"></span>### cryptomgr_probe(): cra_name        = echainiv(authenc(hmac(sha256),cbc(aes)))
<span class="anchor" id="line-2-32"></span>  XXX: goto out
<span class="anchor" id="line-3-25"></span>  XXX: out: echainiv(authenc(hmac(sha256),cbc(aes)))
<span class="anchor" id="line-4-20"></span>### cryptomgr_probe(): cra_name        = echainiv(authenc(hmac(sha256),cbc(aes)))
<span class="anchor" id="line-5-17"></span>  XXX: goto out
<span class="anchor" id="line-6-15"></span>  XXX: out: echainiv(authenc(hmac(sha256),cbc(aes)))</pre><span class="anchor" id="line-1208"></span><span class="anchor" id="line-1209"></span><p class="line862">Which means that this code was executed (from <tt class="backtick">cryptomgr_probe()</tt> function): <span class="anchor" id="line-1210"></span><span class="anchor" id="line-1211"></span><span class="anchor" id="line-1212"></span><span class="anchor" id="line-1213"></span><span class="anchor" id="line-1214"></span><span class="anchor" id="line-1215"></span><span class="anchor" id="line-1216"></span><span class="anchor" id="line-1217"></span><span class="anchor" id="line-1218"></span></p><pre><span class="anchor" id="line-1-81"></span>        tmpl = crypto_lookup_template(param-&gt;template);
<span class="anchor" id="line-2-33"></span>
<span class="anchor" id="line-3-26"></span>        if (!tmpl) {
<span class="anchor" id="line-4-21"></span>                pr_err("  XXX: goto out");
<span class="anchor" id="line-5-18"></span>                goto out;
<span class="anchor" id="line-6-16"></span>        }</pre><span class="anchor" id="line-1219"></span><span class="anchor" id="line-1220"></span><p class="line862">When we look at <tt class="backtick">echainiv(authenc(hmac(sha256),cbc(aes)))</tt>, there are several components in play. Checking each of them in kernel configuration reveals that <tt class="backtick">CONFIG_CRYPTO_ECHAINIV=m</tt>. Let's make it <tt class="backtick">=y</tt>. <span class="anchor" id="line-1221"></span><span class="anchor" id="line-1222"></span></p><p class="line867"><strong>FIX</strong>: After enabling <tt class="backtick">CONFIG_CRYPTO_ECHAINV</tt>,
 everything works. Another way to root cause that option would be to 
enable all crypto options in kernel, and once it works, bisect which one
 was missing (or just leave all crypto options enabled). <span class="anchor" id="line-1223"></span><span class="anchor" id="line-1224"></span></p><p class="line867">
</p><h3 id="A.22Received_signal_15.22_mtpd_issue">"Received signal 15" mtpd issue</h3>
<span class="anchor" id="line-1225"></span><span class="anchor" id="line-1226"></span><p class="line862">When trying to start <tt class="backtick">mtpd</tt>, I'm observing next messages in <tt class="backtick">logcat</tt> (Android side): <span class="anchor" id="line-1227"></span><span class="anchor" id="line-1228"></span><span class="anchor" id="line-1229"></span><span class="anchor" id="line-1230"></span><span class="anchor" id="line-1231"></span><span class="anchor" id="line-1232"></span></p><pre><span class="anchor" id="line-1-82"></span>D mtpd    : Timeout -&gt; Sending SCCRQ
<span class="anchor" id="line-2-34"></span>I mtpd    : Received signal 15
<span class="anchor" id="line-3-27"></span>D mtpd    : Sending STOPCCN
<span class="anchor" id="line-4-22"></span>I mtpd    : Mtpd is terminated (status = 5)</pre><span class="anchor" id="line-1233"></span><span class="anchor" id="line-1234"></span><p class="line862">On PC side I see next output in <tt class="backtick">/var/log/daemon.log</tt>: <span class="anchor" id="line-1235"></span><span class="anchor" id="line-1236"></span><span class="anchor" id="line-1237"></span><span class="anchor" id="line-1238"></span><span class="anchor" id="line-1239"></span><span class="anchor" id="line-1240"></span></p><pre><span class="anchor" id="line-1-83"></span>xl2tpd[3221]: check_control: Received out of order control packet on tunnel -1 (got 1, expected 0)
<span class="anchor" id="line-2-35"></span>xl2tpd[3221]: handle_packet: bad control packet!
<span class="anchor" id="line-3-28"></span>xl2tpd[3221]: network_thread: bad packet
<span class="anchor" id="line-4-23"></span>xl2tpd[3221]: build_fdset: closing down tunnel 47774</pre><span class="anchor" id="line-1241"></span><span class="anchor" id="line-1242"></span><p class="line874">or this one: <span class="anchor" id="line-1243"></span><span class="anchor" id="line-1244"></span><span class="anchor" id="line-1245"></span><span class="anchor" id="line-1246"></span><span class="anchor" id="line-1247"></span><span class="anchor" id="line-1248"></span><span class="anchor" id="line-1249"></span></p><pre><span class="anchor" id="line-1-84"></span>xl2tpd[9998]: result_code_avp: avp is incorrect size.  8 &lt; 10
<span class="anchor" id="line-2-36"></span>xl2tpd[9998]: handle_avps: Bad exit status handling attribute 1 (Result Code) on mandatory packet.
<span class="anchor" id="line-3-29"></span>xl2tpd[9998]: handle_packet: bad AVP handling!
<span class="anchor" id="line-4-24"></span>xl2tpd[9998]: network_thread: bad packet
<span class="anchor" id="line-5-19"></span>xl2tpd[9998]: build_fdset: closing down tunnel 40027</pre><span class="anchor" id="line-1250"></span><span class="anchor" id="line-1251"></span><p class="line867"><strong>FIX</strong>: Just remove <tt class="backtick">/data/misc/vpn/abort</tt> file before running raccon and mtpd. <span class="anchor" id="line-1252"></span><span class="anchor" id="line-1253"></span></p><p class="line874">Root causing: <span class="anchor" id="line-1254"></span></p><ul><li>First I noticed that re-flashing Android images fixes this issue <span class="anchor" id="line-1255"></span></li><li><p class="line862">Then I narrowed it down to <tt class="backtick">userdata.img</tt> re-flashing <span class="anchor" id="line-1256"></span></p></li><li><p class="line862">Doing <tt class="backtick">find&nbsp;/data&nbsp;-name&nbsp;'*vpn*'</tt> I found some VPN related directories <span class="anchor" id="line-1257"></span></p></li><li><p class="line862">Removing <tt class="backtick">/data/misc/vpn/</tt> directory helped <span class="anchor" id="line-1258"></span></p></li><li><p class="line862">By using <a class="http" href="http://androidxref.com/8.0.0_r4/search?q=%2Fdata%2Fmisc%2Fvpn%2Fabort&amp;defs=&amp;refs=&amp;path=&amp;hist=&amp;project=external&amp;project=frameworks">Android Xref site</a> I managed to find actual root cause <span class="anchor" id="line-1259"></span><span class="anchor" id="line-1260"></span><span class="anchor" id="line-1261"></span></p></li></ul><p class="line867">
</p><h3 id="A.22Received_signal_15.22_mtpd_issue_.28.232.29">"Received signal 15" mtpd issue (#2)</h3>
<span class="anchor" id="line-1262"></span><span class="anchor" id="line-1263"></span><p class="line874">After moving to Android-O kernel, this issue appeared again. Sometimes it stops with signal 15: <span class="anchor" id="line-1264"></span><span class="anchor" id="line-1265"></span><span class="anchor" id="line-1266"></span><span class="anchor" id="line-1267"></span><span class="anchor" id="line-1268"></span><span class="anchor" id="line-1269"></span></p><pre><span class="anchor" id="line-1-85"></span>D mtpd    : Timeout -&gt; Sending SCCRQ
<span class="anchor" id="line-2-37"></span>I mtpd    : Received signal 15
<span class="anchor" id="line-3-30"></span>D mtpd    : Sending STOPCCN
<span class="anchor" id="line-4-25"></span>I mtpd    : Mtpd is terminated (status = 5)</pre><span class="anchor" id="line-1270"></span><span class="anchor" id="line-1271"></span><p class="line862">And sometimes it's just printing "Timeout -&gt; Sending SCCRQ" messages constantly in <tt class="backtick">logcat</tt>. <span class="anchor" id="line-1272"></span><span class="anchor" id="line-1273"></span></p><p class="line862">Turns out that HMAC SHA-256 truncation was changed from 96 bit to 128 bit in Android-O kernel (e.g. <tt class="backtick">android-4.4-o</tt> branch), as required by RFC4868. This commit changes it: <span class="anchor" id="line-1274"></span><span class="anchor" id="line-1275"></span></p><p class="line867"><a class="https" href="https://android.googlesource.com/kernel/hikey-linaro/+/a8cc97d8cf4a0d0cf8ce1d99a09546745b11133e">ANDROID: make PF_KEY SHA256 use RFC-compliant truncation</a> <span class="anchor" id="line-1276"></span><span class="anchor" id="line-1277"></span></p><p class="line862">But my server's <tt class="backtick">racoon</tt> still uses 96-bit truncation, because it relies on mainline kernel, which is using 96-bit truncation. <span class="anchor" id="line-1278"></span><span class="anchor" id="line-1279"></span></p><p class="line867"><strong>FIX</strong>: There are two possible solutions to this issue: <span class="anchor" id="line-1280"></span><span class="anchor" id="line-1281"></span></p><p class="line862">1. Change server IPSec tool from <tt class="backtick">racoon</tt> to another one (such as <tt class="backtick">libreswan</tt>), which implements this SHA256 truncation in userspace (and able to choose 128 bit truncation) <span class="anchor" id="line-1282"></span><span class="anchor" id="line-1283"></span></p><p class="line874">2. Revert mentioned patch <span class="anchor" id="line-1284"></span><span class="anchor" id="line-1285"></span></p><p class="line862">For now I decided to go with revert, as configuring <tt class="backtick">libreswan</tt> may take a lot of time, and hacking <tt class="backtick">racoon</tt> won't help either (as it relies on kernel). In future I'll still need to provide working Road Warrior <tt class="backtick">libreswan</tt> configuration, because we'll need simple and reliable way to test my patches. <span class="anchor" id="line-1286"></span><span class="anchor" id="line-1287"></span></p><p class="line874">It also should be noted that Android-N kernel uses 96-bit truncation, thus server must use it too. <span class="anchor" id="line-1288"></span><span class="anchor" id="line-1289"></span></p><p class="line867">
</p><h4 id="Debugging_the_truncation">Debugging the truncation</h4>
<span class="anchor" id="line-1290"></span><span class="anchor" id="line-1291"></span><p class="line862">This issue can be seen from <tt class="backtick">ip&nbsp;xfrm&nbsp;state</tt> command output.  <span class="anchor" id="line-1292"></span><span class="anchor" id="line-1293"></span></p><p class="line867"><em>On PC</em>: <span class="anchor" id="line-1294"></span><span class="anchor" id="line-1295"></span><span class="anchor" id="line-1296"></span><span class="anchor" id="line-1297"></span><span class="anchor" id="line-1298"></span><span class="anchor" id="line-1299"></span><span class="anchor" id="line-1300"></span><span class="anchor" id="line-1301"></span><span class="anchor" id="line-1302"></span><span class="anchor" id="line-1303"></span></p><pre><span class="anchor" id="line-1-86"></span>$ sudo ip xfrm state
<span class="anchor" id="line-2-38"></span>src 192.168.0.1 dst 192.168.0.100
<span class="anchor" id="line-3-31"></span>        ...
<span class="anchor" id="line-4-26"></span>        auth-trunc hmac(sha256) ... 96
<span class="anchor" id="line-5-20"></span>        ...
<span class="anchor" id="line-6-17"></span>src 192.168.0.100 dst 192.168.0.1
<span class="anchor" id="line-7-13"></span>        ...
<span class="anchor" id="line-8-12"></span>        auth-trunc hmac(sha256) ... 96</pre><span class="anchor" id="line-1304"></span><span class="anchor" id="line-1305"></span><p class="line867"><em>On Android</em>: <span class="anchor" id="line-1306"></span><span class="anchor" id="line-1307"></span><span class="anchor" id="line-1308"></span><span class="anchor" id="line-1309"></span><span class="anchor" id="line-1310"></span><span class="anchor" id="line-1311"></span><span class="anchor" id="line-1312"></span><span class="anchor" id="line-1313"></span><span class="anchor" id="line-1314"></span><span class="anchor" id="line-1315"></span><span class="anchor" id="line-1316"></span></p><pre><span class="anchor" id="line-1-87"></span># ip xfrm state
<span class="anchor" id="line-2-39"></span>src 192.168.0.100 dst 192.168.0.1
<span class="anchor" id="line-3-32"></span>        ...
<span class="anchor" id="line-4-27"></span>        auth-trunc hmac(sha256) ... 128
<span class="anchor" id="line-5-21"></span>        ...
<span class="anchor" id="line-6-18"></span>src 192.168.0.1 dst 192.168.0.100
<span class="anchor" id="line-7-14"></span>        ...
<span class="anchor" id="line-8-13"></span>        auth-trunc hmac(sha256) ... 128
<span class="anchor" id="line-9-12"></span>        ...</pre><span class="anchor" id="line-1317"></span><span class="anchor" id="line-1318"></span><p class="line867">
</p><h3 id="A.22avp_is_incorrect_size.__8_.3C_10.22_issue">"avp is incorrect size.  8 &lt; 10" issue</h3>
<span class="anchor" id="line-1319"></span><span class="anchor" id="line-1320"></span><p class="line862">After re-flashing Android images, I was faced with another issue. From <tt class="backtick">logcat</tt>: <span class="anchor" id="line-1321"></span><span class="anchor" id="line-1322"></span><span class="anchor" id="line-1323"></span></p><pre><span class="anchor" id="line-1-88"></span>I mtpd    : Mtpd is terminated (status = 6)</pre><span class="anchor" id="line-1324"></span><span class="anchor" id="line-1325"></span><p class="line862">Looking at <tt class="backtick">/var/log/daemon</tt>: <span class="anchor" id="line-1326"></span><span class="anchor" id="line-1327"></span><span class="anchor" id="line-1328"></span></p><pre><span class="anchor" id="line-1-89"></span>xl2tpd[23168]: result_code_avp: avp is incorrect size.  8 &lt; 10</pre><span class="anchor" id="line-1329"></span><span class="anchor" id="line-1330"></span><p class="line862">Trying to figure out what's going on, I enabled debug logging in <tt class="backtick">/etc/xl2tpd/xl2tpd.conf</tt>: <span class="anchor" id="line-1331"></span><span class="anchor" id="line-1332"></span><span class="anchor" id="line-1333"></span><span class="anchor" id="line-1334"></span><span class="anchor" id="line-1335"></span><span class="anchor" id="line-1336"></span><span class="anchor" id="line-1337"></span><span class="anchor" id="line-1338"></span></p><pre><span class="anchor" id="line-1-90"></span>debug avp = yes
<span class="anchor" id="line-2-40"></span>debug network = yes
<span class="anchor" id="line-3-33"></span>debug state = yes
<span class="anchor" id="line-4-28"></span>debug tunnel = yes
<span class="anchor" id="line-5-22"></span>...
<span class="anchor" id="line-6-19"></span>ppp debug = yes</pre><span class="anchor" id="line-1339"></span><span class="anchor" id="line-1340"></span><p class="line862">Restarted xl2tpd service, started mtpd again. Looking at <tt class="backtick">/var/log/syslog</tt> (as it was last modified file in <tt class="backtick">/var/log/</tt>): <span class="anchor" id="line-1341"></span><span class="anchor" id="line-1342"></span><span class="anchor" id="line-1343"></span></p><pre><span class="anchor" id="line-1-91"></span>pppd[24195]: In file /etc/ppp/xl2tpd-options: unrecognized option 'lock'</pre><span class="anchor" id="line-1344"></span><span class="anchor" id="line-1345"></span><p class="line862">So, it seems like <tt class="backtick">lock</tt> option is deprecated now. <span class="anchor" id="line-1346"></span><span class="anchor" id="line-1347"></span></p><p class="line867"><strong>FIX</strong>: Removing <tt class="backtick">lock</tt> option from <tt class="backtick">/etc/ppp/xl2tpd-options</tt> fixes the problem, and now <tt class="backtick">ppp0</tt> interface comes up, as seen in <tt class="backtick">ifconfig</tt> output (on both sides, Android board and PC). <span class="anchor" id="line-1348"></span><span class="anchor" id="line-1349"></span></p><p class="line867">
</p><h3 id="udp_xmit_failed_with_err.3D-1:No_such_device">udp_xmit failed with err=-1:No such device</h3>
<span class="anchor" id="line-1350"></span><span class="anchor" id="line-1351"></span><p class="line862">When you see such message in <tt class="backtick">/var/log/daemon.log</tt> (when xl2tpd debugging is on), it's probably the bug in xl2tpd 1.3.11, which doesn't work well with kernel 4.15, 4.16, etc. <span class="anchor" id="line-1352"></span><span class="anchor" id="line-1353"></span></p><p class="line862">In <tt class="backtick">logcat</tt> you'll see either: <span class="anchor" id="line-1354"></span></p><ul><li><p class="line862">hanging on <tt class="backtick">D&nbsp;mtpd&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;Timeout&nbsp;-&gt;&nbsp;Sending&nbsp;SCCRQ</tt> <span class="anchor" id="line-1355"></span></p></li><li><p class="line862">or <tt class="backtick">I&nbsp;mtpd&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;Received&nbsp;signal&nbsp;15</tt> <span class="anchor" id="line-1356"></span><span class="anchor" id="line-1357"></span></p></li></ul><p class="line874">See next links for details: <span class="anchor" id="line-1358"></span></p><ul><li><p class="line891"><a class="https" href="https://github.com/xelerance/xl2tpd/issues/147">https://github.com/xelerance/xl2tpd/issues/147</a> <span class="anchor" id="line-1359"></span></p></li><li><p class="line891"><a class="https" href="https://github.com/nm-l2tp/network-manager-l2tp/issues/79">https://github.com/nm-l2tp/network-manager-l2tp/issues/79</a> <span class="anchor" id="line-1360"></span></p></li><li><p class="line891"><a class="https" href="https://github.com/xelerance/xl2tpd/pull/148">https://github.com/xelerance/xl2tpd/pull/148</a> <span class="anchor" id="line-1361"></span></p></li><li><p class="line891"><a class="https" href="https://github.com/xelerance/xl2tpd/commit/9c2cd4933478a83075df5b10f24af7589e90abc3">https://github.com/xelerance/xl2tpd/commit/9c2cd4933478a83075df5b10f24af7589e90abc3</a> <span class="anchor" id="line-1362"></span><span class="anchor" id="line-1363"></span><span class="anchor" id="line-1364"></span></p></li></ul><p class="line867"><strong>FIX</strong>: Build and use xl2tpd from 1.3.12 branch. <strong>WARNING</strong>: After <tt class="backtick">dpkg&nbsp;-i&nbsp;xl2tpd.deb</tt> your <tt class="backtick">/etc/xl2tpd/xl2tpd.conf</tt> will be rewritten by default config, so it might be wise to back it up first. <span class="anchor" id="line-1365"></span><span class="anchor" id="line-1366"></span></p><p class="line867">
</p><h2 id="References">References</h2>
<span class="anchor" id="line-1367"></span><span class="anchor" id="line-1368"></span><p class="line862">[1] <a class="http" href="http://www.marthijnvandenheuvel.com/2012/05/26/how-to-set-up-a-pptp-vpn-server-on-ubuntu/">http://www.marthijnvandenheuvel.com/2012/05/26/how-to-set-up-a-pptp-vpn-server-on-ubuntu/</a> <span class="anchor" id="line-1369"></span><span class="anchor" id="line-1370"></span></p><p class="line862">[2] <a class="https" href="https://wiki.debian.org/HowTo/AndroidVPNServer">https://wiki.debian.org/HowTo/AndroidVPNServer</a> <span class="anchor" id="line-1371"></span><span class="anchor" id="line-1372"></span></p><p class="line862">[3] <a class="http" href="http://www.brokenbitstream.com/mobile-and-vpns">http://www.brokenbitstream.com/mobile-and-vpns</a> <span class="anchor" id="line-1373"></span><span class="anchor" id="line-1374"></span></p><p class="line862">[4] <a class="http" href="http://alvinalexander.com/java/jwarehouse/android/packages/VpnServices/src/com/android/server/vpn/VpnDaemons.java.shtml">http://alvinalexander.com/java/jwarehouse/android/packages/VpnServices/src/com/android/server/vpn/VpnDaemons.java.shtml</a> <span class="anchor" id="line-1375"></span><span class="anchor" id="line-1376"></span></p><p class="line862">[5] <a class="http" href="http://wiki.nikoforge.org/L2TP/IPSec_VPN_Setup_on_Centos_6_%2864-bit%29_for_use_with_Android_ICS_and_iOS_5_Clients">http://wiki.nikoforge.org/L2TP/IPSec_VPN_Setup_on_Centos_6_%2864-bit%29_for_use_with_Android_ICS_and_iOS_5_Clients</a> <span class="anchor" id="line-1377"></span><span class="anchor" id="line-1378"></span></p><p class="line862">[6] "Android Security Internals" book: chapter 9 -&gt; "Vpn Support" <span class="anchor" id="line-1379"></span><span class="anchor" id="line-1380"></span></p><p class="line862">[7] <a class="http" href="http://miqloproxy.com/what-is-l2tp/">http://miqloproxy.com/what-is-l2tp/</a> <span class="anchor" id="line-1381"></span><span class="anchor" id="line-1382"></span></p><p class="line862">[8] <a class="https" href="https://ask.wireshark.org/questions/12019/how-can-i-decrypt-ikev1-andor-esp-packets">https://ask.wireshark.org/questions/12019/how-can-i-decrypt-ikev1-andor-esp-packets</a> <span class="anchor" id="line-1383"></span><span class="anchor" id="line-1384"></span></p><p class="line862">[9] <a class="https" href="https://code.google.com/p/android/issues/detail?id=196939">https://code.google.com/p/android/issues/detail?id=196939</a> <span class="anchor" id="line-1385"></span><span class="anchor" id="bottom"></span></p></div><p id="pageinfo" class="info" dir="ltr" lang="en">LMG/Kernel/PPP  (last modified 2018-10-29 14:04:29)</p>

</div>
</div>
</div>
<div id="pagebottom"></div>


<div id="footer">
<div id="footer_inner">

        <div id="footer_social" class="repeat">
            <h2 class="rulelight light">Follow <span>Linaro</span></h2>
            <a target="_blank" href="https://www.linaro.org/blog" class="repeat socials blog" title="Visit the Linaro Blog"><span></span>Blog</a>
            <a target="_blank" href="https://www.linaro.org/planet/" class="repeat socials planet pad-right" title="Read blog posts from around the web about Linaro"><span></span>Planet</a>
            <a target="_blank" href="https://www.facebook.com/pages/Linaro/155974581091106" class="repeat socials facebook" title="Visit Linaro's Facebook page"><span></span>Facebook</a>
            <a target="_blank" href="https://www.flickr.com/photos/linaroorg/" class="repeat socials flickr" title="See photos from Linaro events on our Flickr channel"><span></span>Flickr</a>
            <a target="_blank" href="https://twitter.com/linaroorg" class="repeat socials twitter" title="Connect with Linaro on Twitter"><span></span>Twitter</a>
            <a target="_blank" href="https://www.youtube.com/user/linaroorg" class="repeat socials youtube" title="View video content from Linaro on YouTube"><span></span>Youtube</a>
        </div>

        <div id="footer_nav" class="repeat">
            <p class="rulelight light small">
                Portions of this content © 2010 - 2019 <span>Linaro</span>
            </p>
            <p class="light small">
                <a target="_blank" href="https://www.linaro.org/sitemap" title="View a full sitemap of www.linaro.org">Sitemap</a>|
                <a target="_blank" href="https://www.linaro.org/legal" title="Linaro Terms, Conditions and Privacy Policy">Legal</a>|
                <a target="_blank" href="https://www.linaro.org/contact" title="Contact details for Linaro">Contact</a>|
                深圳市秋家源贸易有限公司 <a rel="nofollow" href="http://www.beian.miit.gov.cn/">粤ICP备17104008号-2</a>
            </p>
            <p class="light small"></p><ul id="credits">
<li><a href="https://moinmo.in/" title="This site uses the MoinMoin Wiki software.">MoinMoin Powered</a></li><li><a href="https://moinmo.in/Python" title="MoinMoin is written in Python.">Python Powered</a></li><li><a href="https://moinmo.in/GPL" title="MoinMoin is GPL licensed.">GPL licensed</a></li>
</ul>
<p></p>
        </div>

</div>
</div>

<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-16756069-2']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript';
    ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(ga, s);
  })();

</script>



</body></html>